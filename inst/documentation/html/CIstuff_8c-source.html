<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: CIstuff.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>CIstuff.c</h1><a href="CIstuff_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="PL2__common_8h.html">PL2_common.h</a>"</span>
00010 
00011 
<a name="l00012"></a><a class="code" href="CIstuff_8c.html#a0">00012</a> SEXP <a class="code" href="CIstuff_8c.html#a0">R_blocksetup</a> (SEXP block) {
00013 
00014     <span class="keywordtype">int</span> n, nlev, nlevels, i, j, *iblock, l;
00015     SEXP ans, dims, indices, dummies, pindices, lindex;
00016     
00017     n = LENGTH(block);
00018     iblock = INTEGER(block);
00019     nlevels = 1;
00020     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
00021         <span class="keywordflow">if</span> (iblock[i] &gt; nlevels) nlevels++;
00022     }
00023     
00024     PROTECT(ans = allocVector(VECSXP, 4));
00025     SET_VECTOR_ELT(ans, 0, dims = allocVector(INTSXP, 2));
00026     SET_VECTOR_ELT(ans, 1, indices = allocVector(VECSXP, nlevels));
00027     SET_VECTOR_ELT(ans, 2, dummies = allocVector(VECSXP, nlevels));
00028     SET_VECTOR_ELT(ans, 3, pindices = allocVector(VECSXP, nlevels));
00029     
00030     INTEGER(dims)[0] = n;
00031     INTEGER(dims)[1] = nlevels;
00032 
00033     <span class="keywordflow">for</span> (l = 1; l &lt;= nlevels; l++) {
00034     
00035         <span class="comment">/* number of elements in block `l' */</span>
00036         nlev = 0;   
00037         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
00038             <span class="keywordflow">if</span> (iblock[i] == l) nlev++;
00039         }
00040                                                 
00041         <span class="comment">/* which(block == l) and memory setup */</span>
00042         SET_VECTOR_ELT(indices, l - 1, lindex = allocVector(INTSXP, nlev));
00043         SET_VECTOR_ELT(dummies, l - 1, allocVector(INTSXP, nlev));
00044         SET_VECTOR_ELT(pindices, l - 1, allocVector(INTSXP, nlev));
00045 
00046         j = 0;
00047         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {   
00048             <span class="keywordflow">if</span> (iblock[i] == l) {
00049                 INTEGER(lindex)[j] = i;
00050                 j++; 
00051             }
00052         }
00053     }
00054 
00055     UNPROTECT(1);
00056     <span class="keywordflow">return</span>(ans);
00057 }
00058 
00059 
<a name="l00066"></a><a class="code" href="CIstuff_8c.html#a1">00066</a> <span class="keywordtype">void</span> <a class="code" href="CIstuff_8c.html#a1">C_blockperm</a> (SEXP blocksetup, <span class="keywordtype">int</span> *ans) {
00067                   
00068     <span class="keywordtype">int</span> n, nlevels, l, nlev, j, *iindex, *ipindex;
00069     SEXP indices, dummies, pindices, index, dummy, pindex;
00070 
00071     n = INTEGER(VECTOR_ELT(blocksetup, 0))[0];
00072     nlevels = INTEGER(VECTOR_ELT(blocksetup, 0))[1];
00073     indices = VECTOR_ELT(blocksetup, 1);
00074     dummies = VECTOR_ELT(blocksetup, 2);
00075     pindices = VECTOR_ELT(blocksetup, 3);
00076     
00077     <span class="keywordflow">for</span> (l = 1; l &lt;= nlevels; l++) {
00078     
00079         <span class="comment">/* number of elements in block `l' */</span>
00080         index = VECTOR_ELT(indices, l - 1);
00081         dummy = VECTOR_ELT(dummies, l - 1);
00082         pindex = VECTOR_ELT(pindices, l - 1);
00083         nlev = LENGTH(index);
00084         iindex = INTEGER(index);
00085         ipindex = INTEGER(pindex);
00086 
00087         <a class="code" href="Utils_8c.html#a13">C_SampleNoReplace</a>(INTEGER(dummy), nlev, nlev, ipindex);
00088 
00089         <span class="keywordflow">for</span> (j = 0; j &lt; nlev; j++) {
00090             ans[iindex[j]] = iindex[ipindex[j]];
00091         }
00092     }
00093 }
00094 
<a name="l00095"></a><a class="code" href="CIstuff_8c.html#a2">00095</a> SEXP <a class="code" href="CIstuff_8c.html#a2">R_blockperm</a> (SEXP block) {
00096 
00097     SEXP blocksetup, ans;
00098     
00099     blocksetup = <a class="code" href="CIstuff_8c.html#a0">R_blocksetup</a>(block);
00100     PROTECT(ans = allocVector(INTSXP, LENGTH(block)));
00101     GetRNGstate();
00102     <a class="code" href="CIstuff_8c.html#a1">C_blockperm</a>(blocksetup, INTEGER(ans));
00103     PutRNGstate();
00104     UNPROTECT(1);
00105     <span class="keywordflow">return</span>(ans);
00106 }
00107 
<a name="l00108"></a><a class="code" href="CIstuff_8c.html#a3">00108</a> SEXP <a class="code" href="CIstuff_8c.html#a3">R_MonteCarloIndependenceTest</a> (SEXP x, SEXP y, SEXP block, SEXP B) {
00109 
00110     <span class="keywordtype">int</span> n, p, q, pq, i, *index, *permindex, b, Bsim;
00111     SEXP ans, blocksetup, linstat;
00112     <span class="keywordtype">double</span> *dx, *dy;
00113     
00114     n = <a class="code" href="Utils_8c.html#a18">nrow</a>(x);
00115     p = <a class="code" href="Utils_8c.html#a19">ncol</a>(x);
00116     q = <a class="code" href="Utils_8c.html#a19">ncol</a>(y);
00117     pq = p*q;
00118     Bsim = INTEGER(B)[0];
00119     dx = REAL(x);
00120     dy = REAL(y);
00121     
00122     index = Calloc(n, <span class="keywordtype">int</span>);
00123     permindex = Calloc(n, <span class="keywordtype">int</span>);
00124 
00125     PROTECT(blocksetup = <a class="code" href="CIstuff_8c.html#a0">R_blocksetup</a>(block));
00126 
00127     PROTECT(ans = allocVector(VECSXP, Bsim));
00128     
00129     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
00130         index[i] = i;
00131         
00132     GetRNGstate();
00133         
00134     <span class="keywordflow">for</span> (b = 0; b &lt; Bsim; b++) {
00135         <a class="code" href="CIstuff_8c.html#a1">C_blockperm</a>(blocksetup, permindex);
00136         SET_VECTOR_ELT(ans, b, linstat = allocVector(REALSXP, pq));
00137         <a class="code" href="LinearStatistic_8c.html#a6">C_PermutedLinearStatistic</a>(dx, p, dy, q, n, n, index, permindex, REAL(linstat));
00138     }
00139 
00140     PutRNGstate();
00141 
00142     UNPROTECT(2);
00143     <span class="keywordflow">return</span>(ans);
00144 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jun 9 14:28:10 2005 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
