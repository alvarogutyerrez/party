<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: Predict.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>Predict.c</h1><a href="Predict_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
00010 
00011 
<a name="l00021"></a><a class="code" href="Predict_8h.html#a0">00021</a> <span class="keywordtype">void</span> <a class="code" href="Predict_8c.html#a0">C_splitnode</a>(SEXP node, SEXP learnsample, SEXP control) {
00022 
00023     SEXP weights, leftnode, rightnode, split;
00024     SEXP responses, inputs, whichNA;
00025     <span class="keywordtype">double</span> cutpoint, *dx, *dweights, *leftweights, *rightweights;
00026     <span class="keywordtype">double</span> sleft = 0.0, sright = 0.0;
00027     <span class="keywordtype">int</span> *ix, *levelset, *iwhichNA;
00028     <span class="keywordtype">int</span> nobs, i, nna;
00029                     
00030     weights = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(node);
00031     dweights = REAL(weights);
00032     responses = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>);
00033     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00034     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(learnsample);
00035             
00036     <span class="comment">/* set up memory for the left daughter */</span>
00037     SET_VECTOR_ELT(node, <a class="code" href="party_8h.html#a7">S3_LEFT</a>, leftnode = allocVector(VECSXP, <a class="code" href="party_8h.html#a9">NODE_LENGTH</a>));
00038     <a class="code" href="S3Classes_8c.html#a0">C_init_node</a>(leftnode, nobs, 
00039         <a class="code" href="Classes_8c.html#a91">get_ninputs</a>(learnsample), <a class="code" href="Classes_8c.html#a100">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#a96">get_splitctrl</a>(control)),
00040         <a class="code" href="Utils_8c.html#a19">ncol</a>(GET_SLOT(GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>),
00041                       <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>)));
00042     leftweights = REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(leftnode));
00043 
00044     <span class="comment">/* set up memory for the right daughter */</span>
00045     SET_VECTOR_ELT(node, <a class="code" href="party_8h.html#a8">S3_RIGHT</a>, 
00046                    rightnode = allocVector(VECSXP, <a class="code" href="party_8h.html#a9">NODE_LENGTH</a>));
00047     <a class="code" href="S3Classes_8c.html#a0">C_init_node</a>(rightnode, nobs, 
00048         <a class="code" href="Classes_8c.html#a91">get_ninputs</a>(learnsample), <a class="code" href="Classes_8c.html#a100">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#a96">get_splitctrl</a>(control)),
00049         <a class="code" href="Utils_8c.html#a19">ncol</a>(GET_SLOT(GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>),
00050                       <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>)));
00051     rightweights = REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(rightnode));
00052 
00053     <span class="comment">/* split according to the primary split */</span>
00054     split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00055     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a80">has_missings</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split))) {
00056         whichNA = <a class="code" href="Classes_8c.html#a84">get_missings</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split));
00057         iwhichNA = INTEGER(whichNA);
00058         nna = LENGTH(whichNA);
00059     } <span class="keywordflow">else</span> {
00060         nna = 0;
00061         whichNA = R_NilValue;
00062         iwhichNA = NULL;
00063     }
00064     
00065     <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a18">S3is_ordered</a>(split)) {
00066         cutpoint = REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split))[0];
00067         dx = REAL(<a class="code" href="Classes_8c.html#a76">get_variable</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)));
00068         <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00069             <span class="keywordflow">if</span> (nna &gt; 0) {
00070                 <span class="keywordflow">if</span> (<a class="code" href="Utils_8c.html#a16">i_in_set</a>(i + 1, iwhichNA, nna)) <span class="keywordflow">continue</span>;
00071             }
00072             <span class="keywordflow">if</span> (dx[i] &lt;= cutpoint) 
00073                 leftweights[i] = dweights[i]; 
00074             <span class="keywordflow">else</span> 
00075                 leftweights[i] = 0.0;
00076             rightweights[i] = dweights[i] - leftweights[i];
00077             sleft += leftweights[i];
00078             sright += rightweights[i];
00079         }
00080     } <span class="keywordflow">else</span> {
00081         levelset = INTEGER(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split));
00082         ix = INTEGER(<a class="code" href="Classes_8c.html#a76">get_variable</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)));
00083 
00084         <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00085             <span class="keywordflow">if</span> (nna &gt; 0) {
00086                 <span class="keywordflow">if</span> (<a class="code" href="Utils_8c.html#a16">i_in_set</a>(i + 1, iwhichNA, nna)) <span class="keywordflow">continue</span>;
00087             }
00088             <span class="keywordflow">if</span> (levelset[ix[i] - 1])
00089                 leftweights[i] = dweights[i];
00090             <span class="keywordflow">else</span> 
00091                 leftweights[i] = 0.0;
00092             rightweights[i] = dweights[i] - leftweights[i];
00093             sleft += leftweights[i];
00094             sright += rightweights[i];
00095         }
00096     }
00097     
00098     <span class="comment">/* for the moment: NA's go with majority */</span>
00099     <span class="keywordflow">if</span> (nna &gt; 0) {
00100         <span class="keywordflow">for</span> (i = 0; i &lt; nna; i++) {
00101             <span class="keywordflow">if</span> (sleft &gt; sright) {
00102                 leftweights[iwhichNA[i] - 1] = dweights[iwhichNA[i] - 1];
00103                 rightweights[iwhichNA[i] - 1] = 0.0;
00104             } <span class="keywordflow">else</span> {
00105                 rightweights[iwhichNA[i] - 1] = dweights[iwhichNA[i] - 1];
00106                 leftweights[iwhichNA[i] - 1] = 0.0;
00107             }
00108         }
00109     }
00110 }
00111 
00112 
<a name="l00122"></a><a class="code" href="Predict_8c.html#a1">00122</a> SEXP <a class="code" href="Predict_8c.html#a1">C_get_node</a>(SEXP subtree, SEXP newinputs, 
00123                 <span class="keywordtype">double</span> mincriterion, <span class="keywordtype">int</span> numobs) {
00124 
00125     SEXP split, whichNA, weights, ssplit, surrsplit;
00126     <span class="keywordtype">double</span> cutpoint, x, *dweights, swleft, swright;
00127     <span class="keywordtype">int</span> level, *levelset, i, ns;
00128 
00129     <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a8">S3get_nodeterminal</a>(subtree) || 
00130         REAL(<a class="code" href="S3Classes_8c.html#a6">S3get_maxcriterion</a>(subtree))[0] &lt; mincriterion) 
00131         <span class="keywordflow">return</span>(subtree);
00132     
00133     split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(subtree);
00134 
00135     <span class="comment">/* missing values. Maybe store the proportions left / </span>
00136 <span class="comment">       right in each node? */</span>
00137     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a80">has_missings</a>(newinputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split))) {
00138         whichNA = <a class="code" href="Classes_8c.html#a84">get_missings</a>(newinputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split));
00139     
00140         <span class="keywordflow">if</span> (<a class="code" href="Utils_8c.html#a17">C_i_in_set</a>(numobs, whichNA)) {
00141         
00142             surrsplit = <a class="code" href="S3Classes_8c.html#a10">S3get_surrogatesplits</a>(subtree);
00143             ns = 0;
00144             i = numobs;      
00145 
00146             <span class="comment">/* try to find a surrogate split */</span>
00147             <span class="keywordflow">while</span>(TRUE) {
00148     
00149                 <span class="keywordflow">if</span> (ns &gt;= LENGTH(surrsplit)) <span class="keywordflow">break</span>;
00150             
00151                 ssplit = VECTOR_ELT(surrsplit, ns);
00152                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a80">has_missings</a>(newinputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(ssplit))) {
00153                     <span class="keywordflow">if</span> (INTEGER(<a class="code" href="Classes_8c.html#a84">get_missings</a>(newinputs, 
00154                                              <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(ssplit)))[i]) {
00155                         ns++;
00156                         <span class="keywordflow">continue</span>;
00157                     }
00158                 }
00159 
00160                 cutpoint = REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(ssplit))[0];
00161                 x = REAL(<a class="code" href="Classes_8c.html#a76">get_variable</a>(newinputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(ssplit)))[i];
00162                      
00163                 <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a21">S3get_toleft</a>(ssplit)) {
00164                     <span class="keywordflow">if</span> (x &lt;= cutpoint) {
00165                         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree),
00166                                           newinputs, mincriterion, numobs));
00167                     } <span class="keywordflow">else</span> {
00168                         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree),
00169                                newinputs, mincriterion, numobs));
00170                     }
00171                 } <span class="keywordflow">else</span> {
00172                     <span class="keywordflow">if</span> (x &lt;= cutpoint) {
00173                         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree),
00174                                           newinputs, mincriterion, numobs));
00175                     } <span class="keywordflow">else</span> {
00176                         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree),
00177                                newinputs, mincriterion, numobs));
00178                     }
00179                 }
00180                 <span class="keywordflow">break</span>;
00181             }
00182 
00183             <span class="comment">/* if this was not successful, we go with the majority */</span>
00184             weights = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree));
00185             dweights = REAL(weights);
00186             swleft = 0.0;
00187             <span class="keywordflow">for</span> (i = 0; i &lt; LENGTH(weights); i++)
00188                 swleft += dweights[i];
00189             weights = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree));
00190             dweights = REAL(weights);
00191             swright = 0.0;
00192             <span class="keywordflow">for</span> (i = 0; i &lt; LENGTH(weights); i++)
00193                 swright += dweights[i];
00194             <span class="keywordflow">if</span> (swleft &gt; swright) {
00195                 <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree), 
00196                                   newinputs, mincriterion, numobs));
00197             } <span class="keywordflow">else</span> {
00198                 <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree), 
00199                                   newinputs, mincriterion, numobs));
00200             }
00201         }
00202     }
00203     
00204     <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a18">S3is_ordered</a>(split)) {
00205         cutpoint = REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split))[0];
00206         x = REAL(<a class="code" href="Classes_8c.html#a76">get_variable</a>(newinputs, 
00207                      <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)))[numobs];
00208         <span class="keywordflow">if</span> (x &lt;= cutpoint) {
00209             <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree), 
00210                               newinputs, mincriterion, numobs));
00211         } <span class="keywordflow">else</span> {
00212             <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree), 
00213                               newinputs, mincriterion, numobs));
00214         }
00215     } <span class="keywordflow">else</span> {
00216         levelset = INTEGER(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split));
00217         level = INTEGER(<a class="code" href="Classes_8c.html#a76">get_variable</a>(newinputs, 
00218                             <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)))[numobs];
00219         <span class="comment">/* level is in 1, ..., K */</span>
00220         <span class="keywordflow">if</span> (levelset[level - 1]) {
00221             <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree), newinputs, 
00222                               mincriterion, numobs));
00223         } <span class="keywordflow">else</span> {
00224             <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree), newinputs, 
00225                               mincriterion, numobs));
00226         }
00227     }
00228 }
00229 
00230 
<a name="l00239"></a><a class="code" href="Predict_8c.html#a2">00239</a> SEXP <a class="code" href="Predict_8c.html#a2">R_get_node</a>(SEXP subtree, SEXP newinputs, SEXP mincriterion, 
00240                 SEXP numobs) {
00241     <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(subtree, newinputs, REAL(mincriterion)[0],
00242                       INTEGER(numobs)[0] - 1));
00243 }
00244 
00245 
<a name="l00252"></a><a class="code" href="Predict_8c.html#a3">00252</a> SEXP <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(SEXP subtree, <span class="keywordtype">int</span> nodenum) {
00253     
00254     <span class="keywordflow">if</span> (nodenum == <a class="code" href="S3Classes_8c.html#a2">S3get_nodeID</a>(subtree)) <span class="keywordflow">return</span>(subtree);
00255 
00256     <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a8">S3get_nodeterminal</a>(subtree)) 
00257         error(<span class="stringliteral">"no node with number %d\n"</span>, nodenum);
00258 
00259     <span class="keywordflow">if</span> (nodenum &lt; <a class="code" href="S3Classes_8c.html#a2">S3get_nodeID</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree))) {
00260         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(subtree), nodenum));
00261     } <span class="keywordflow">else</span> {
00262         <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(subtree), nodenum));
00263     }
00264 }
00265 
00266 
<a name="l00273"></a><a class="code" href="Predict_8c.html#a4">00273</a> SEXP <a class="code" href="Predict_8c.html#a4">R_get_nodebynum</a>(SEXP subtree, SEXP nodenum) {
00274     <span class="keywordflow">return</span>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(subtree, INTEGER(nodenum)[0]));
00275 }
00276 
00277 
<a name="l00286"></a><a class="code" href="Predict_8c.html#a5">00286</a> SEXP <a class="code" href="Predict_8c.html#a5">C_get_prediction</a>(SEXP subtree, SEXP newinputs, 
00287                       <span class="keywordtype">double</span> mincriterion, <span class="keywordtype">int</span> numobs) {
00288     <span class="keywordflow">return</span>(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(subtree, newinputs, 
00289                             mincriterion, numobs)));
00290 }
00291 
00292 
<a name="l00301"></a><a class="code" href="Predict_8c.html#a6">00301</a> SEXP <a class="code" href="Predict_8c.html#a6">C_get_nodeweights</a>(SEXP subtree, SEXP newinputs, 
00302                        <span class="keywordtype">double</span> mincriterion, <span class="keywordtype">int</span> numobs) {
00303     <span class="keywordflow">return</span>(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(subtree, newinputs, 
00304                              mincriterion, numobs)));
00305 }
00306 
00307 
<a name="l00316"></a><a class="code" href="Predict_8c.html#a7">00316</a> <span class="keywordtype">int</span> <a class="code" href="Predict_8c.html#a7">C_get_nodeID</a>(SEXP subtree, SEXP newinputs,
00317                   <span class="keywordtype">double</span> mincriterion, <span class="keywordtype">int</span> numobs) {
00318      <span class="keywordflow">return</span>(<a class="code" href="S3Classes_8c.html#a2">S3get_nodeID</a>(<a class="code" href="Predict_8c.html#a1">C_get_node</a>(subtree, newinputs, 
00319             mincriterion, numobs)));
00320 }
00321 
00322 
<a name="l00330"></a><a class="code" href="Predict_8c.html#a8">00330</a> SEXP <a class="code" href="Predict_8c.html#a8">R_get_nodeID</a>(SEXP tree, SEXP newinputs, SEXP mincriterion) {
00331 
00332     SEXP ans;
00333     <span class="keywordtype">int</span> nobs, i, *dans;
00334             
00335     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00336     PROTECT(ans = allocVector(INTSXP, nobs));
00337     dans = INTEGER(ans);
00338     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
00339          dans[i] = <a class="code" href="Predict_8c.html#a7">C_get_nodeID</a>(tree, newinputs, REAL(mincriterion)[0], i);
00340     UNPROTECT(1);
00341     <span class="keywordflow">return</span>(ans);
00342 }
00343 
00344 
<a name="l00353"></a><a class="code" href="Predict_8c.html#a9">00353</a> <span class="keywordtype">void</span> <a class="code" href="Predict_8c.html#a9">C_predict</a>(SEXP tree, SEXP newinputs, <span class="keywordtype">double</span> mincriterion, SEXP ans) {
00354     
00355     <span class="keywordtype">int</span> nobs, i;
00356     
00357     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);    
00358     <span class="keywordflow">if</span> (LENGTH(ans) != nobs) 
00359         error(<span class="stringliteral">"ans is not of length %d\n"</span>, nobs);
00360         
00361     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
00362         SET_VECTOR_ELT(ans, i, <a class="code" href="Predict_8c.html#a5">C_get_prediction</a>(tree, newinputs, 
00363                        mincriterion, i));
00364 }
00365 
00366 
<a name="l00374"></a><a class="code" href="Predict_8c.html#a10">00374</a> SEXP <a class="code" href="Predict_8c.html#a10">R_predict</a>(SEXP tree, SEXP newinputs, SEXP mincriterion) {
00375 
00376     SEXP ans;
00377     <span class="keywordtype">int</span> nobs;
00378     
00379     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00380     PROTECT(ans = allocVector(VECSXP, nobs));
00381     <a class="code" href="Predict_8c.html#a9">C_predict</a>(tree, newinputs, REAL(mincriterion)[0], ans);
00382     UNPROTECT(1);
00383     <span class="keywordflow">return</span>(ans);
00384 }
00385 
00386 
<a name="l00394"></a><a class="code" href="Predict_8c.html#a11">00394</a> <span class="keywordtype">void</span> <a class="code" href="Predict_8c.html#a11">C_getpredictions</a>(SEXP tree, SEXP where, SEXP ans) {
00395 
00396     <span class="keywordtype">int</span> nobs, i, *iwhere;
00397     
00398     nobs = LENGTH(where);
00399     iwhere = INTEGER(where);
00400     <span class="keywordflow">if</span> (LENGTH(ans) != nobs)
00401         error(<span class="stringliteral">"ans is not of length %d\n"</span>, nobs);
00402         
00403     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
00404         SET_VECTOR_ELT(ans, i, <a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(
00405             <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, iwhere[i])));
00406 }
00407 
00408 
<a name="l00415"></a><a class="code" href="Predict_8c.html#a12">00415</a> SEXP <a class="code" href="Predict_8c.html#a12">R_getpredictions</a>(SEXP tree, SEXP where) {
00416 
00417     SEXP ans;
00418     <span class="keywordtype">int</span> nobs;
00419             
00420     nobs = LENGTH(where);
00421     PROTECT(ans = allocVector(VECSXP, nobs));
00422     <a class="code" href="Predict_8c.html#a11">C_getpredictions</a>(tree, where, ans);
00423     UNPROTECT(1);
00424     <span class="keywordflow">return</span>(ans);
00425 }                        
00426 
00427 
<a name="l00435"></a><a class="code" href="Predict_8c.html#a13">00435</a> <span class="keywordtype">void</span> <a class="code" href="Predict_8c.html#a13">C_getweights</a>(SEXP tree, SEXP where, SEXP ans) {
00436 
00437     <span class="keywordtype">int</span> nobs, i, *iwhere;
00438     
00439     nobs = LENGTH(where);
00440     iwhere = INTEGER(where);
00441     <span class="keywordflow">if</span> (LENGTH(ans) != nobs)
00442         error(<span class="stringliteral">"ans is not of length %d\n"</span>, nobs);
00443         
00444     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
00445         SET_VECTOR_ELT(ans, i, <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(
00446             <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, iwhere[i])));
00447 }
00448 
00449 
<a name="l00456"></a><a class="code" href="Predict_8c.html#a14">00456</a> SEXP <a class="code" href="Predict_8c.html#a14">R_getweights</a>(SEXP tree, SEXP where) {
00457 
00458     SEXP ans;
00459     <span class="keywordtype">int</span> nobs;
00460             
00461     nobs = LENGTH(where);
00462     PROTECT(ans = allocVector(VECSXP, nobs));
00463     <a class="code" href="Predict_8c.html#a13">C_getweights</a>(tree, where, ans);
00464     UNPROTECT(1);
00465     <span class="keywordflow">return</span>(ans);
00466 }                        
00467 
00468 
<a name="l00477"></a><a class="code" href="Predict_8c.html#a15">00477</a> <span class="keywordtype">void</span> <a class="code" href="Predict_8c.html#a15">C_weights</a>(SEXP tree, SEXP newinputs, 
00478                <span class="keywordtype">double</span> mincriterion, SEXP ans) {
00479     
00480     <span class="keywordtype">int</span> nobs, i;
00481     
00482     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);    
00483     <span class="keywordflow">if</span> (LENGTH(ans) != nobs) 
00484         error(<span class="stringliteral">"ans is not of length %d\n"</span>, nobs);
00485         
00486     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
00487         SET_VECTOR_ELT(ans, i, <a class="code" href="Predict_8c.html#a6">C_get_nodeweights</a>(tree, newinputs, 
00488                        mincriterion, i));
00489 }
00490 
00491 
<a name="l00499"></a><a class="code" href="Predict_8c.html#a16">00499</a> SEXP <a class="code" href="Predict_8c.html#a16">R_weights</a>(SEXP tree, SEXP newinputs, SEXP mincriterion) {
00500 
00501     SEXP ans;
00502     <span class="keywordtype">int</span> nobs;
00503     
00504     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00505     PROTECT(ans = allocVector(VECSXP, nobs));
00506     <a class="code" href="Predict_8c.html#a15">C_weights</a>(tree, newinputs, REAL(mincriterion)[0], ans);
00507     UNPROTECT(1);
00508     <span class="keywordflow">return</span>(ans);
00509 }
00510 
00511 
<a name="l00520"></a><a class="code" href="Predict_8c.html#a17">00520</a> SEXP <a class="code" href="Predict_8c.html#a17">R_predictRF</a>(SEXP forest, SEXP newinputs, SEXP mincriterion, SEXP oobpred) {
00521 
00522     SEXP ans, tmp, tree;
00523     <span class="keywordtype">int</span> ntrees, nobs, i, b, j, q, iwhere, oob = 0, count = 0;
00524     
00525     <span class="keywordflow">if</span> (LOGICAL(oobpred)[0]) oob = 1;
00526     
00527     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00528     ntrees = LENGTH(forest);
00529     q = LENGTH(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(
00530                    <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(VECTOR_ELT(forest, 0), 1)));
00531 
00532     <span class="keywordflow">if</span> (oob) {
00533         <span class="keywordflow">if</span> (LENGTH(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(
00534                        <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(VECTOR_ELT(forest, 0), 1))) != nobs)
00535             error(<span class="stringliteral">"number of observations don't match"</span>);
00536     }    
00537     
00538     PROTECT(ans = allocVector(VECSXP, nobs));
00539     
00540     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00541         count = 0;
00542         SET_VECTOR_ELT(ans, i, allocVector(REALSXP, q));
00543         <span class="keywordflow">for</span> (j = 0; j &lt; q; j++)
00544                     REAL(VECTOR_ELT(ans, i))[j] = 0.0;
00545         <span class="keywordflow">for</span> (b = 0; b &lt; ntrees; b++) {
00546             tree = VECTOR_ELT(forest, b);
00547 
00548             <span class="keywordflow">if</span> (oob &amp;&amp; 
00549                 REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, 1)))[i] &gt; 0.0) 
00550                 <span class="keywordflow">continue</span>;
00551 
00552             iwhere = <a class="code" href="Predict_8c.html#a7">C_get_nodeID</a>(tree, newinputs, REAL(mincriterion)[0], i);
00553             tmp = <a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, iwhere));
00554             <span class="keywordflow">for</span> (j = 0; j &lt; q; j++)
00555                 REAL(VECTOR_ELT(ans, i))[j] += REAL(tmp)[j];
00556             count++;
00557         }
00558         <span class="keywordflow">if</span> (count == 0) 
00559             error(<span class="stringliteral">"cannot compute out-of-bag predictions for obs "</span>, i + 1);
00560         <span class="keywordflow">for</span> (j = 0; j &lt; q; j++)
00561             REAL(VECTOR_ELT(ans, i))[j] = REAL(VECTOR_ELT(ans, i))[j] / count;
00562     }
00563     UNPROTECT(1);
00564     <span class="keywordflow">return</span>(ans);
00565 }
00566 
<a name="l00576"></a><a class="code" href="Predict_8c.html#a18">00576</a> SEXP <a class="code" href="Predict_8c.html#a18">R_predictRF2</a>(SEXP forest, SEXP response, SEXP newinputs, 
00577                   SEXP mincriterion, SEXP oobpred) {
00578 
00579     SEXP ans, tmp, tree, w;
00580     <span class="keywordtype">int</span> ntrees, nobs, i, b, j, q, n, iwhere, oob = 0;
00581     <span class="keywordtype">double</span> *dtmp, *dw, sumw = 0.0;
00582 
00583     <span class="keywordflow">if</span> (LOGICAL(oobpred)[0]) oob = 1;
00584     
00585     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00586     ntrees = LENGTH(forest);
00587     n = <a class="code" href="Utils_8c.html#a18">nrow</a>(response);
00588     q = <a class="code" href="Utils_8c.html#a19">ncol</a>(response);
00589 
00590     <span class="keywordflow">if</span> (oob) {
00591         <span class="keywordflow">if</span> (n != nobs)
00592             error(<span class="stringliteral">"number of observations don't match"</span>);
00593     }    
00594     
00595     PROTECT(ans = allocVector(VECSXP, nobs));
00596     PROTECT(w = allocMatrix(REALSXP, 1, n));
00597     dw = REAL(w);
00598     
00599     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00600 
00601         SET_VECTOR_ELT(ans, i, allocVector(REALSXP, q));
00602         <span class="keywordflow">for</span> (j = 0; j &lt; n; j++)
00603             dw[j] = 0.0;
00604 
00605         <span class="keywordflow">for</span> (b = 0; b &lt; ntrees; b++) {
00606             tree = VECTOR_ELT(forest, b);
00607 
00608             <span class="keywordflow">if</span> (oob &amp;&amp; 
00609                 REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, 1)))[i] &gt; 0.0) 
00610                 <span class="keywordflow">continue</span>;
00611 
00612             iwhere = <a class="code" href="Predict_8c.html#a7">C_get_nodeID</a>(tree, newinputs, REAL(mincriterion)[0], i);
00613             tmp = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, iwhere));
00614             dtmp = REAL(tmp);
00615             
00616             <span class="keywordflow">for</span> (j = 0; j &lt; n; j++)
00617                 dw[j] += dtmp[j];
00618         }
00619         
00620         <a class="code" href="Utils_8c.html#a9">C_matprod</a>(dw, 1, n, REAL(response), n, q, REAL(VECTOR_ELT(ans, i)));
00621 
00622         sumw = 0.0;
00623         <span class="keywordflow">for</span> (j = 0; j &lt; n; j++)
00624             sumw += dw[j];
00625 
00626         <span class="keywordflow">for</span> (j = 0; j &lt; q; j++)
00627             REAL(VECTOR_ELT(ans, i))[j] = REAL(VECTOR_ELT(ans, i))[j] / sumw;
00628     }
00629     UNPROTECT(2);
00630     <span class="keywordflow">return</span>(ans);
00631 }
00632 
<a name="l00641"></a><a class="code" href="Predict_8c.html#a19">00641</a> SEXP <a class="code" href="Predict_8c.html#a19">R_predictRF_weights</a>(SEXP forest, SEXP newinputs, SEXP mincriterion, SEXP oobpred) {
00642 
00643     SEXP ans, tree, bw;
00644     <span class="keywordtype">int</span> ntrees, nobs, i, b, j, q, iwhere, oob = 0, count = 0, ntrain;
00645     <span class="keywordtype">double</span> *dtmp;
00646     
00647     <span class="keywordflow">if</span> (LOGICAL(oobpred)[0]) oob = 1;
00648     
00649     nobs = <a class="code" href="Classes_8c.html#a90">get_nobs</a>(newinputs);
00650     ntrees = LENGTH(forest);
00651     q = LENGTH(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(
00652                    <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(VECTOR_ELT(forest, 0), 1)));
00653 
00654     <span class="keywordflow">if</span> (oob) {
00655         <span class="keywordflow">if</span> (LENGTH(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(
00656                        <a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(VECTOR_ELT(forest, 0), 1))) != nobs)
00657             error(<span class="stringliteral">"number of observations don't match"</span>);
00658     }    
00659     
00660     tree = VECTOR_ELT(forest, 0);
00661     ntrain = LENGTH(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, 1)));
00662     
00663     PROTECT(ans = allocVector(VECSXP, nobs));
00664     
00665     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00666         count = 0;
00667         SET_VECTOR_ELT(ans, i, bw = allocVector(REALSXP, ntrain));
00668         <span class="keywordflow">for</span> (j = 0; j &lt; ntrain; j++)
00669             REAL(bw)[j] = 0.0;
00670         <span class="keywordflow">for</span> (b = 0; b &lt; ntrees; b++) {
00671             tree = VECTOR_ELT(forest, b);
00672 
00673             <span class="keywordflow">if</span> (oob &amp;&amp; 
00674                 REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, 1)))[i] &gt; 0.0) 
00675                 <span class="keywordflow">continue</span>;
00676 
00677             iwhere = <a class="code" href="Predict_8c.html#a7">C_get_nodeID</a>(tree, newinputs, REAL(mincriterion)[0], i);
00678             dtmp = REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="Predict_8c.html#a3">C_get_nodebynum</a>(tree, iwhere)));
00679             <span class="keywordflow">for</span> (j = 0; j &lt; ntrain; j++)
00680                 REAL(bw)[j] += dtmp[j];
00681             count++;
00682         }
00683         <span class="keywordflow">if</span> (count == 0) 
00684             error(<span class="stringliteral">"cannot compute out-of-bag predictions for obs "</span>, i + 1);
00685     }
00686     UNPROTECT(1);
00687     <span class="keywordflow">return</span>(ans);
00688 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Apr 4 13:20:29 2006 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
