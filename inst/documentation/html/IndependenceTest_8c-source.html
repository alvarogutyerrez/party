<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: IndependenceTest.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>IndependenceTest.c</h1><a href="IndependenceTest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
00010 
00011 
<a name="l00021"></a><a class="code" href="IndependenceTest_8h.html#a1">00021</a> <span class="keywordtype">void</span> <a class="code" href="IndependenceTest_8c.html#a0">C_TeststatPvalue</a>(<span class="keyword">const</span> SEXP linexpcov, <span class="keyword">const</span> SEXP varctrl, 
00022                       <span class="keywordtype">double</span> *ans_teststat, <span class="keywordtype">double</span> *ans_pvalue) {
00023     
00024     <span class="keywordtype">double</span> releps, abseps, tol;
00025     <span class="keywordtype">int</span> maxpts;
00026     
00027     maxpts = <a class="code" href="Classes_8c.html#a67">get_maxpts</a>(varctrl);
00028     tol = <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl);
00029     abseps = <a class="code" href="Classes_8c.html#a68">get_abseps</a>(varctrl);
00030     releps = <a class="code" href="Classes_8c.html#a69">get_releps</a>(varctrl);
00031     
00032     <span class="comment">/* compute the test statistic */</span>
00033     ans_teststat[0] = <a class="code" href="Convenience_8c.html#a3">C_TestStatistic</a>(linexpcov, <a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl), 
00034                                   <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl));
00035 
00036     <span class="comment">/* compute the p-value if requested */</span>                                  
00037     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a65">get_pvalue</a>(varctrl))
00038         ans_pvalue[0] =  <a class="code" href="Convenience_8c.html#a4">C_ConditionalPvalue</a>(ans_teststat[0], linexpcov, 
00039                                          <a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl),
00040                                          tol, &amp;maxpts, &amp;releps, &amp;abseps);
00041     <span class="keywordflow">else</span>
00042         ans_pvalue[0] = 1.0;
00043 }
00044 
<a name="l00053"></a><a class="code" href="IndependenceTest_8h.html#a2">00053</a> <span class="keywordtype">void</span> <a class="code" href="IndependenceTest_8c.html#a1">C_TeststatCriterion</a>(<span class="keyword">const</span> SEXP linexpcov, <span class="keyword">const</span> SEXP varctrl, 
00054                          <span class="keywordtype">double</span> *ans_teststat, <span class="keywordtype">double</span> *ans_criterion) {
00055     
00056     <a class="code" href="IndependenceTest_8c.html#a0">C_TeststatPvalue</a>(linexpcov, varctrl, ans_teststat, ans_criterion);
00057     
00058     <span class="comment">/* the node criterion is to be MAXIMISED, </span>
00059 <span class="comment">       i.e. 1-pvalue or test statistic \in \[0, \infty\] */</span>
00060     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a65">get_pvalue</a>(varctrl))
00061         ans_criterion[0] = 1 - ans_criterion[0];
00062     <span class="keywordflow">else</span>
00063         ans_criterion[0] = ans_teststat[0];
00064     
00065 }
00066 
00067 
<a name="l00081"></a><a class="code" href="IndependenceTest_8c.html#a2">00081</a> <span class="keywordtype">void</span> <a class="code" href="IndependenceTest_8c.html#a2">C_IndependenceTest</a>(<span class="keyword">const</span> SEXP x, <span class="keyword">const</span> SEXP y, <span class="keyword">const</span> SEXP weights, 
00082                         <span class="keyword">const</span> SEXP ScoreMatrix, SEXP Mlinexpcov, 
00083                         <span class="keyword">const</span> <span class="keywordtype">int</span> ORDERED, SEXP linexpcov, SEXP varctrl, 
00084                         SEXP ans) {
00085     
00086     <span class="comment">/* compute linear statistic and its conditional expectation and</span>
00087 <span class="comment">       covariance</span>
00088 <span class="comment">    */</span>
00089     <a class="code" href="Convenience_8c.html#a0">C_LinStatExpCov</a>(REAL(x), <a class="code" href="Utils_8c.html#a19">ncol</a>(x), REAL(y), <a class="code" href="Utils_8c.html#a19">ncol</a>(y), 
00090                     REAL(weights), <a class="code" href="Utils_8c.html#a18">nrow</a>(x), 1, 
00091                     GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>), linexpcov);
00092 
00093     <span class="comment">/* if one (or both) variables are ordered multiply linear statistic,</span>
00094 <span class="comment">       expectation and covariance</span>
00095 <span class="comment">     */</span>
00096     <span class="keywordflow">if</span> (ORDERED) {
00097         <a class="code" href="Convenience_8c.html#a2">C_MLinearStatistic</a>(linexpcov, ScoreMatrix, Mlinexpcov);
00098         
00099         <span class="comment">/* for quadform type test statistics, compute the Moore-Penrose inverse</span>
00100 <span class="comment">           of the covariance matrix</span>
00101 <span class="comment">         */</span>
00102         <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl) == 2) 
00103             <a class="code" href="Convenience_8c.html#a1">C_LinStatExpCovMPinv</a>(Mlinexpcov, <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl));
00104             
00105         <span class="comment">/* compute test statistic and pvalue */</span>
00106         <a class="code" href="IndependenceTest_8c.html#a0">C_TeststatPvalue</a>(Mlinexpcov, varctrl, &amp;REAL(ans)[0], &amp;REAL(ans)[1]);
00107     } <span class="keywordflow">else</span> {
00108         <span class="comment">/* for unordered variables */</span>
00109         <span class="keywordflow">if</span>(<a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl) == 2) 
00110             <a class="code" href="Convenience_8c.html#a1">C_LinStatExpCovMPinv</a>(linexpcov, <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl));
00111         <a class="code" href="IndependenceTest_8c.html#a0">C_TeststatPvalue</a>(linexpcov, varctrl, &amp;REAL(ans)[0], &amp;REAL(ans)[1]);
00112     }
00113 }
00114 
00115 
<a name="l00127"></a><a class="code" href="IndependenceTest_8c.html#a3">00127</a> SEXP <a class="code" href="IndependenceTest_8c.html#a3">R_IndependenceTest</a>(SEXP x, SEXP y, SEXP weights, SEXP ScoreMatrix, 
00128                         SEXP Mlinexpcov, SEXP linexpcov, SEXP varctrl) {
00129                         
00130     SEXP ans;
00131     <span class="keywordtype">int</span> scores = 0;
00132     
00133     PROTECT(ans = allocVector(REALSXP, 2));
00134     <span class="keywordflow">if</span> (ScoreMatrix != R_NilValue &amp;&amp; Mlinexpcov != R_NilValue)
00135         scores = 1;
00136         
00137     <a class="code" href="IndependenceTest_8c.html#a2">C_IndependenceTest</a>(x, y, weights, ScoreMatrix, Mlinexpcov, scores, 
00138                        linexpcov, varctrl, ans);
00139     UNPROTECT(1);
00140     <span class="keywordflow">return</span>(ans);
00141 }
00142 
00143 
<a name="l00157"></a><a class="code" href="IndependenceTest_8h.html#a0">00157</a> <span class="keywordtype">void</span> <a class="code" href="IndependenceTest_8c.html#a4">C_GlobalTest</a>(<span class="keyword">const</span> SEXP learnsample, <span class="keyword">const</span> SEXP weights, 
00158                   SEXP fitmem, <span class="keyword">const</span> SEXP varctrl, 
00159                   <span class="keyword">const</span> SEXP gtctrl, <span class="keyword">const</span> <span class="keywordtype">double</span> minsplit, 
00160                   <span class="keywordtype">double</span> *ans_teststat, <span class="keywordtype">double</span> *ans_criterion) {
00161 
00162     <span class="keywordtype">int</span> ninputs, nobs, yORDERED, xORDERED, j, i, k, RECALC = 1, type;
00163     SEXP responses, inputs, y, x, xmem, Mxmem, expcovinf;
00164     SEXP thiswhichNA;
00165     <span class="keywordtype">double</span> *thisweights, *dweights, *pvaltmp;
00166     <span class="keywordtype">int</span> *ithiswhichNA, RANDOM, mtry, *randomvar, *index;
00167     <span class="keywordtype">int</span> *dontuse, *dontusetmp;
00168     
00169     ninputs = <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample);
00170     nobs = <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample);
00171     responses = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>);
00172     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00173     dweights = REAL(weights);
00174     
00175     yORDERED = <a class="code" href="Classes_8c.html#a77">is_ordinal</a>(responses, 1);
00176     y = <a class="code" href="Classes_8c.html#a73">get_transformation</a>(responses, 1);
00177     
00178     expcovinf = GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
00179     <a class="code" href="LinearStatistic_8c.html#a2">C_ExpectCovarInfluence</a>(REAL(y), <a class="code" href="Utils_8c.html#a19">ncol</a>(y), REAL(weights), 
00180                            nobs, expcovinf);
00181     
00182     <span class="keywordflow">if</span> (REAL(GET_SLOT(expcovinf, <a class="code" href="Classes_8c.html#a5">PL2_sumweightsSym</a>))[0] &lt; minsplit) {
00183         <span class="keywordflow">for</span> (j = 0; j &lt; ninputs; j++) {
00184             ans_teststat[j] = 0.0;
00185             ans_criterion[j] = 0.0;
00186         }
00187     } <span class="keywordflow">else</span> {
00188 
00189         dontuse = INTEGER(<a class="code" href="Classes_8c.html#a102">get_dontuse</a>(fitmem));
00190         dontusetmp = INTEGER(<a class="code" href="Classes_8c.html#a103">get_dontusetmp</a>(fitmem));
00191     
00192         <span class="keywordflow">for</span> (j = 0; j &lt; ninputs; j++) dontusetmp[j] = !dontuse[j];
00193     
00194         <span class="comment">/* random forest */</span>
00195         RANDOM = <a class="code" href="Classes_8c.html#a100">get_randomsplits</a>(gtctrl);
00196         mtry = <a class="code" href="Classes_8c.html#a101">get_mtry</a>(gtctrl);
00197         <span class="keywordflow">if</span> (RANDOM &amp; (mtry &gt; ninputs)) {
00198             warning(<span class="stringliteral">"mtry is larger than ninputs, using mtry = inputs"</span>);
00199             mtry = ninputs;
00200             RANDOM = 0;
00201         }
00202         <span class="keywordflow">if</span> (RANDOM) {
00203             index = Calloc(ninputs, <span class="keywordtype">int</span>);
00204             randomvar = Calloc(mtry, <span class="keywordtype">int</span>);
00205             GetRNGstate();
00206             <a class="code" href="Utils_8c.html#a13">C_SampleNoReplace</a>(index, ninputs, mtry, randomvar);
00207             PutRNGstate();
00208             j = 0;
00209             <span class="keywordflow">for</span> (k = 0; k &lt; mtry; k++) {
00210                 j = randomvar[k];
00211                 <span class="keywordflow">while</span>(dontuse[j] &amp;&amp; j &lt; ninputs) j++;
00212                 <span class="keywordflow">if</span> (j == ninputs) 
00213                     error(<span class="stringliteral">"not enough variables to sample from"</span>);
00214                 dontusetmp[j] = 0;
00215             }
00216             Free(index);
00217             Free(randomvar);
00218         }
00219 
00220         <span class="keywordflow">for</span> (j = 1; j &lt;= ninputs; j++) {
00221 
00222             <span class="keywordflow">if</span> ((RANDOM &amp;&amp; dontusetmp[j - 1]) || dontuse[j - 1]) {
00223                 ans_teststat[j - 1] = 0.0;
00224                 ans_criterion[j - 1] = 0.0;
00225                 <span class="keywordflow">continue</span>; 
00226             }
00227         
00228             x = <a class="code" href="Classes_8c.html#a73">get_transformation</a>(inputs, j);
00229             xORDERED = <a class="code" href="Classes_8c.html#a77">is_ordinal</a>(inputs, j);
00230 
00231             xmem = <a class="code" href="Classes_8c.html#a84">get_varmemory</a>(fitmem, j);
00232             <span class="keywordflow">if</span> (!<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, j)) {
00233                 <a class="code" href="Convenience_8c.html#a0">C_LinStatExpCov</a>(REAL(x), <a class="code" href="Utils_8c.html#a19">ncol</a>(x), REAL(y), <a class="code" href="Utils_8c.html#a19">ncol</a>(y),
00234                                 REAL(weights), <a class="code" href="Utils_8c.html#a18">nrow</a>(x), !RECALC, expcovinf,
00235                                 xmem);
00236             } <span class="keywordflow">else</span> {
00237                 thisweights = REAL(<a class="code" href="Classes_8c.html#a91">get_weights</a>(fitmem, j));
00238                 thiswhichNA = <a class="code" href="Classes_8c.html#a83">get_missings</a>(inputs, j);
00239                 ithiswhichNA = INTEGER(thiswhichNA);
00240                 <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) thisweights[i] = dweights[i];
00241                 <span class="keywordflow">for</span> (k = 0; k &lt; LENGTH(thiswhichNA); k++)
00242                     thisweights[ithiswhichNA[k] - 1] = 0.0;
00243                 <a class="code" href="Convenience_8c.html#a0">C_LinStatExpCov</a>(REAL(x), <a class="code" href="Utils_8c.html#a19">ncol</a>(x), REAL(y), <a class="code" href="Utils_8c.html#a19">ncol</a>(y),
00244                                 thisweights, <a class="code" href="Utils_8c.html#a18">nrow</a>(x), RECALC, 
00245                                 GET_SLOT(xmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>),
00246                                 xmem);
00247             }
00248             <span class="keywordflow">if</span> (yORDERED || xORDERED) {
00249                 Mxmem = <a class="code" href="Classes_8c.html#a85">get_varMmemory</a>(fitmem, j);
00250                 <a class="code" href="Convenience_8c.html#a2">C_MLinearStatistic</a>(xmem, <a class="code" href="Classes_8c.html#a86">get_Mscorematrix</a>(fitmem, j), Mxmem);
00251                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl) == 2)
00252                     <a class="code" href="Convenience_8c.html#a1">C_LinStatExpCovMPinv</a>(Mxmem, <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl));
00253                     <a class="code" href="IndependenceTest_8c.html#a1">C_TeststatCriterion</a>(Mxmem, varctrl, &amp;ans_teststat[j - 1], 
00254                                         &amp;ans_criterion[j - 1]);
00255             } <span class="keywordflow">else</span> {
00256                 <span class="keywordflow">if</span>(<a class="code" href="Classes_8c.html#a64">get_teststattype</a>(varctrl) == 2)
00257                     <a class="code" href="Convenience_8c.html#a1">C_LinStatExpCovMPinv</a>(xmem, <a class="code" href="Classes_8c.html#a66">get_tol</a>(varctrl));
00258                 <a class="code" href="IndependenceTest_8c.html#a1">C_TeststatCriterion</a>(xmem, varctrl, &amp;ans_teststat[j - 1], 
00259                                     &amp;ans_criterion[j - 1]);
00260             }
00261         }                
00262 
00263         type = <a class="code" href="Classes_8c.html#a92">get_testtype</a>(gtctrl);
00264         <span class="keywordflow">switch</span>(type) {
00265             <span class="comment">/* Bonferroni */</span>
00266             <span class="keywordflow">case</span> <a class="code" href="party_8h.html#a23">BONFERRONI</a>: 
00267                     <span class="keywordflow">for</span> (j = 0; j &lt; ninputs; j++) {
00268                         ans_criterion[j] = 1 - (1 - ans_criterion[j])*ninputs;
00269                         <span class="keywordflow">if</span> (ans_criterion[j] &lt; 0) 
00270                             ans_criterion[j] = 0.0;
00271                     }
00272                     <span class="keywordflow">break</span>;
00273             <span class="comment">/* Monte-Carlo */</span>
00274             <span class="keywordflow">case</span> <a class="code" href="party_8h.html#a24">MONTECARLO</a>: 
00275                     pvaltmp = Calloc(ninputs, <span class="keywordtype">double</span>);
00276                     <a class="code" href="Distributions_8c.html#a4">C_MonteCarlo</a>(ans_criterion, learnsample, weights, fitmem, 
00277                                  varctrl, gtctrl, pvaltmp);
00278                     <span class="keywordflow">for</span> (j = 0; j &lt; ninputs; j++)
00279                         ans_criterion[j] = 1 - pvaltmp[j];
00280                     Free(pvaltmp);
00281                     <span class="keywordflow">break</span>;
00282             <span class="comment">/* aggregated */</span>
00283             <span class="keywordflow">case</span> <a class="code" href="party_8h.html#a25">AGGREGATED</a>: 
00284                     error(<span class="stringliteral">"C_GlobalTest: aggregated global test not yet implemented"</span>);
00285                     <span class="keywordflow">break</span>;
00286             <span class="comment">/* raw */</span>
00287             <span class="keywordflow">case</span> <a class="code" href="party_8h.html#a26">RAW</a>: <span class="keywordflow">break</span>;
00288             <span class="keywordflow">default</span>: error(<span class="stringliteral">"C_GlobalTest: undefined value for type argument"</span>);
00289                      <span class="keywordflow">break</span>;
00290         }
00291     }
00292 }
00293 
00294 
<a name="l00304"></a><a class="code" href="IndependenceTest_8c.html#a5">00304</a> SEXP <a class="code" href="IndependenceTest_8c.html#a5">R_GlobalTest</a>(SEXP learnsample, SEXP weights, SEXP fitmem, 
00305                   SEXP varctrl, SEXP gtctrl) {
00306 
00307     SEXP ans, teststat, criterion;
00308     
00309     PROTECT(ans = allocVector(VECSXP, 2));
00310     SET_VECTOR_ELT(ans, 0, 
00311         teststat = allocVector(REALSXP, <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample)));
00312     SET_VECTOR_ELT(ans, 1, 
00313         criterion = allocVector(REALSXP, <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample)));
00314 
00315     <a class="code" href="IndependenceTest_8c.html#a4">C_GlobalTest</a>(learnsample, weights, fitmem, varctrl, gtctrl, 0, 
00316                  REAL(teststat), REAL(criterion));
00317     
00318     UNPROTECT(1);
00319     <span class="keywordflow">return</span>(ans);
00320 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 6 01:02:54 2005 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
