<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: Node.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>Node.c</h1><a href="Node_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 
<a name="l00022"></a><a class="code" href="Node_8c.html#a0">00022</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a0">C_prediction</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *y, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> q, <span class="keyword">const</span> <span class="keywordtype">double</span> *weights, 
<a name="l00023"></a>00023                   <span class="keyword">const</span> <span class="keywordtype">double</span> sweights, <span class="keywordtype">double</span> *ans) {
<a name="l00024"></a>00024 
<a name="l00025"></a>00025     <span class="keywordtype">int</span> i, j, jn;
<a name="l00026"></a>00026     
<a name="l00027"></a>00027     <span class="keywordflow">for</span> (j = 0; j &lt; q; j++) {
<a name="l00028"></a>00028         ans[j] = 0.0;
<a name="l00029"></a>00029         jn = j * n;
<a name="l00030"></a>00030         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) 
<a name="l00031"></a>00031             ans[j] += weights[i] * y[jn + i];
<a name="l00032"></a>00032         ans[j] = ans[j] / sweights;
<a name="l00033"></a>00033     }
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00048"></a><a class="code" href="Node_8h.html#a0">00048</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a1">C_Node</a>(SEXP node, SEXP learnsample, SEXP weights, 
<a name="l00049"></a>00049             SEXP fitmem, SEXP controls, <span class="keywordtype">int</span> TERMINAL) {
<a name="l00050"></a>00050     
<a name="l00051"></a>00051     <span class="keywordtype">int</span> nobs, ninputs, jselect, yORDERED, q, j, k, i;
<a name="l00052"></a>00052     <span class="keywordtype">double</span> mincriterion, sweights, *dprediction;
<a name="l00053"></a>00053     <span class="keywordtype">double</span> *teststat, *pvalue, smax, cutpoint = 0.0, maxstat = 0.0;
<a name="l00054"></a>00054     <span class="keywordtype">double</span> *standstat, *splitstat;
<a name="l00055"></a>00055     SEXP responses, inputs, y, x, expcovinf, thisweights, linexpcov;
<a name="l00056"></a>00056     SEXP varctrl, splitctrl, gtctrl, tgctrl, split, joint;
<a name="l00057"></a>00057     <span class="keywordtype">double</span> *dxtransf, *dweights;
<a name="l00058"></a>00058     <span class="keywordtype">int</span> *itable;
<a name="l00059"></a>00059     
<a name="l00060"></a>00060     nobs = <a class="code" href="Classes_8c.html#a93">get_nobs</a>(learnsample);
<a name="l00061"></a>00061     ninputs = <a class="code" href="Classes_8c.html#a94">get_ninputs</a>(learnsample);
<a name="l00062"></a>00062     varctrl = <a class="code" href="Classes_8c.html#a98">get_varctrl</a>(controls);
<a name="l00063"></a>00063     splitctrl = <a class="code" href="Classes_8c.html#a99">get_splitctrl</a>(controls);
<a name="l00064"></a>00064     gtctrl = <a class="code" href="Classes_8c.html#a100">get_gtctrl</a>(controls);
<a name="l00065"></a>00065     tgctrl = <a class="code" href="Classes_8c.html#a101">get_tgctrl</a>(controls);
<a name="l00066"></a>00066     mincriterion = <a class="code" href="Classes_8c.html#a102">get_mincriterion</a>(gtctrl);
<a name="l00067"></a>00067     responses = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>);
<a name="l00068"></a>00068     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
<a name="l00069"></a>00069     yORDERED = <a class="code" href="Classes_8c.html#a81">is_ordinal</a>(responses, 1); 
<a name="l00070"></a>00070     y = <a class="code" href="Classes_8c.html#a77">get_transformation</a>(responses, 1);
<a name="l00071"></a>00071     q = <a class="code" href="Utils_8c.html#a19">ncol</a>(y);
<a name="l00072"></a>00072     joint = GET_SLOT(responses, <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">/* &lt;FIXME&gt; we compute C_GlobalTest even for TERMINAL nodes! &lt;/FIXME&gt; */</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="comment">/* compute the test statistics and the node criteria for each input */</span>        
<a name="l00077"></a>00077     <a class="code" href="IndependenceTest_8c.html#a4">C_GlobalTest</a>(learnsample, weights, fitmem, varctrl,
<a name="l00078"></a>00078                  gtctrl, <a class="code" href="Classes_8c.html#a74">get_minsplit</a>(splitctrl), 
<a name="l00079"></a>00079                  REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node)), REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node)));
<a name="l00080"></a>00080     
<a name="l00081"></a>00081     <span class="comment">/* sum of weights: C_GlobalTest did nothing if sweights &lt; mincriterion */</span>
<a name="l00082"></a>00082     sweights = REAL(GET_SLOT(GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>), 
<a name="l00083"></a>00083                              <a class="code" href="Classes_8c.html#a5">PL2_sumweightsSym</a>))[0];
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="comment">/* compute the prediction of this node */</span>
<a name="l00086"></a>00086     dprediction = REAL(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(node));
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="comment">/* &lt;FIXME&gt; feed raw numeric values OR dummy encoded factors as y </span>
<a name="l00089"></a>00089 <span class="comment">       Problem: what happens for survival times ? */</span>
<a name="l00090"></a>00090     <a class="code" href="Node_8c.html#a0">C_prediction</a>(REAL(joint), nobs, <a class="code" href="Utils_8c.html#a19">ncol</a>(joint), REAL(weights), 
<a name="l00091"></a>00091                      sweights, dprediction);
<a name="l00092"></a>00092     <span class="comment">/* &lt;/FIXME&gt; */</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     teststat = REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node));
<a name="l00095"></a>00095     pvalue = REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node));
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">/* try the two out of ninputs best inputs variables */</span>
<a name="l00098"></a>00098     <span class="comment">/* &lt;FIXME&gt; be more flexible and add a parameter controlling</span>
<a name="l00099"></a>00099 <span class="comment">               the number of inputs tried &lt;/FIXME&gt; */</span>
<a name="l00100"></a>00100     <span class="keywordflow">for</span> (j = 0; j &lt; 2; j++) {
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         smax = <a class="code" href="Utils_8c.html#a5">C_max</a>(pvalue, ninputs);
<a name="l00103"></a>00103         REAL(<a class="code" href="S3Classes_8c.html#a6">S3get_maxcriterion</a>(node))[0] = smax;
<a name="l00104"></a>00104     
<a name="l00105"></a>00105         <span class="comment">/* if the global null hypothesis was rejected */</span>
<a name="l00106"></a>00106         <span class="keywordflow">if</span> (smax &gt; mincriterion &amp;&amp; !TERMINAL) {
<a name="l00107"></a>00107 
<a name="l00108"></a>00108             <span class="comment">/* the input variable with largest association to the response */</span>
<a name="l00109"></a>00109             jselect = <a class="code" href="Utils_8c.html#a20">C_whichmax</a>(pvalue, teststat, ninputs) + 1;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111             <span class="comment">/* get the raw numeric values or the codings of a factor */</span>
<a name="l00112"></a>00112             x = <a class="code" href="Classes_8c.html#a79">get_variable</a>(inputs, jselect);
<a name="l00113"></a>00113             <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a83">has_missings</a>(inputs, jselect)) {
<a name="l00114"></a>00114                 expcovinf = GET_SLOT(<a class="code" href="Classes_8c.html#a88">get_varmemory</a>(fitmem, jselect), 
<a name="l00115"></a>00115                                     <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
<a name="l00116"></a>00116                 thisweights = <a class="code" href="Classes_8c.html#a95">get_weights</a>(fitmem, jselect);
<a name="l00117"></a>00117             } <span class="keywordflow">else</span> {
<a name="l00118"></a>00118                 expcovinf = GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
<a name="l00119"></a>00119                 thisweights = weights;
<a name="l00120"></a>00120             }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122             <span class="comment">/* &lt;FIXME&gt; handle ordered factors separatly??? &lt;/FIXME&gt; */</span>
<a name="l00123"></a>00123             <span class="keywordflow">if</span> (!<a class="code" href="Classes_8c.html#a80">is_nominal</a>(inputs, jselect)) {
<a name="l00124"></a>00124             
<a name="l00125"></a>00125                 <span class="comment">/* search for a split in a ordered variable x */</span>
<a name="l00126"></a>00126                 split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
<a name="l00127"></a>00127                 
<a name="l00128"></a>00128                 <span class="comment">/* check if the n-vector of splitstatistics </span>
<a name="l00129"></a>00129 <span class="comment">                   should be returned for each primary split */</span>
<a name="l00130"></a>00130                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a91">get_savesplitstats</a>(tgctrl)) {
<a name="l00131"></a>00131                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, nobs);
<a name="l00132"></a>00132                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
<a name="l00133"></a>00133                 } <span class="keywordflow">else</span> {
<a name="l00134"></a>00134                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, 0);
<a name="l00135"></a>00135                     splitstat = REAL(<a class="code" href="Classes_8c.html#a92">get_splitstatistics</a>(fitmem));
<a name="l00136"></a>00136                 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138                 <a class="code" href="Splits_8c.html#a0">C_split</a>(REAL(x), 1, REAL(y), q, REAL(weights), nobs,
<a name="l00139"></a>00139                         INTEGER(<a class="code" href="Classes_8c.html#a84">get_ordering</a>(inputs, jselect)), 
<a name="l00140"></a>00140                         REAL(VECTOR_ELT(GET_SLOT(responses, <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
<a name="l00141"></a>00141                         yORDERED, splitctrl, 
<a name="l00142"></a>00142                         GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
<a name="l00143"></a>00143                         expcovinf, REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)), &amp;maxstat,
<a name="l00144"></a>00144                         splitstat);
<a name="l00145"></a>00145                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
<a name="l00146"></a>00146              } <span class="keywordflow">else</span> {
<a name="l00147"></a>00147            
<a name="l00148"></a>00148                  <span class="comment">/* search of a set of levels (split) in a numeric variable x */</span>
<a name="l00149"></a>00149                  split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
<a name="l00150"></a>00150                  
<a name="l00151"></a>00151                 <span class="comment">/* check if the n-vector of splitstatistics </span>
<a name="l00152"></a>00152 <span class="comment">                   should be returned for each primary split */</span>
<a name="l00153"></a>00153                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a91">get_savesplitstats</a>(tgctrl)) {
<a name="l00154"></a>00154                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
<a name="l00155"></a>00155                         LENGTH(<a class="code" href="Classes_8c.html#a85">get_levels</a>(inputs, jselect)), 
<a name="l00156"></a>00156                         nobs);
<a name="l00157"></a>00157                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
<a name="l00158"></a>00158                 } <span class="keywordflow">else</span> {
<a name="l00159"></a>00159                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
<a name="l00160"></a>00160                         LENGTH(<a class="code" href="Classes_8c.html#a85">get_levels</a>(inputs, jselect)), 
<a name="l00161"></a>00161                         0);
<a name="l00162"></a>00162                     splitstat = REAL(<a class="code" href="Classes_8c.html#a92">get_splitstatistics</a>(fitmem));
<a name="l00163"></a>00163                 }
<a name="l00164"></a>00164           
<a name="l00165"></a>00165                  linexpcov = <a class="code" href="Classes_8c.html#a88">get_varmemory</a>(fitmem, jselect);
<a name="l00166"></a>00166                  standstat = Calloc(<a class="code" href="Classes_8c.html#a67">get_dimension</a>(linexpcov), <span class="keywordtype">double</span>);
<a name="l00167"></a>00167                  <a class="code" href="TestStatistic_8c.html#a0">C_standardize</a>(REAL(GET_SLOT(linexpcov, 
<a name="l00168"></a>00168                                              <a class="code" href="Classes_8c.html#a2">PL2_linearstatisticSym</a>)),
<a name="l00169"></a>00169                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a0">PL2_expectationSym</a>)),
<a name="l00170"></a>00170                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a1">PL2_covarianceSym</a>)),
<a name="l00171"></a>00171                                <a class="code" href="Classes_8c.html#a67">get_dimension</a>(linexpcov), <a class="code" href="Classes_8c.html#a70">get_tol</a>(splitctrl), 
<a name="l00172"></a>00172                                standstat);
<a name="l00173"></a>00173  
<a name="l00174"></a>00174                  <a class="code" href="Splits_8c.html#a2">C_splitcategorical</a>(INTEGER(x), 
<a name="l00175"></a>00175                                     LENGTH(<a class="code" href="Classes_8c.html#a85">get_levels</a>(inputs, jselect)), 
<a name="l00176"></a>00176                                     REAL(y), q, REAL(weights), 
<a name="l00177"></a>00177                                     nobs, REAL(VECTOR_ELT(GET_SLOT(responses, 
<a name="l00178"></a>00178                                                <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
<a name="l00179"></a>00179                                     yORDERED, standstat, splitctrl, 
<a name="l00180"></a>00180                                     GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
<a name="l00181"></a>00181                                     expcovinf, &amp;cutpoint, 
<a name="l00182"></a>00182                                     INTEGER(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)),
<a name="l00183"></a>00183                                     &amp;maxstat, splitstat);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185                  <span class="comment">/* compute which levels of a factor are available in this node </span>
<a name="l00186"></a>00186 <span class="comment">                    (for printing) later on. A real `table' for this node would</span>
<a name="l00187"></a>00187 <span class="comment">                    induce too much overhead here. Maybe later. */</span>
<a name="l00188"></a>00188                     
<a name="l00189"></a>00189                  itable = INTEGER(<a class="code" href="S3Classes_8c.html#a25">S3get_table</a>(split));
<a name="l00190"></a>00190                  dxtransf = REAL(<a class="code" href="Classes_8c.html#a77">get_transformation</a>(inputs, jselect));
<a name="l00191"></a>00191                  dweights = REAL(thisweights);
<a name="l00192"></a>00192                  <span class="keywordflow">for</span> (k = 0; k &lt; LENGTH(<a class="code" href="Classes_8c.html#a85">get_levels</a>(inputs, jselect)); k++) {
<a name="l00193"></a>00193                      itable[k] = 0;
<a name="l00194"></a>00194                      <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
<a name="l00195"></a>00195                          <span class="keywordflow">if</span> (dxtransf[k * nobs + i] * dweights[i] &gt; 0) {
<a name="l00196"></a>00196                              itable[k] = 1;
<a name="l00197"></a>00197                              <span class="keywordflow">continue</span>;
<a name="l00198"></a>00198                          }
<a name="l00199"></a>00199                      }
<a name="l00200"></a>00200                  }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202                  Free(standstat);
<a name="l00203"></a>00203             }
<a name="l00204"></a>00204             <span class="keywordflow">if</span> (maxstat == 0) {
<a name="l00205"></a>00205                 warning(<span class="stringliteral">"no admissible split found\n"</span>);
<a name="l00206"></a>00206             
<a name="l00207"></a>00207                 <span class="keywordflow">if</span> (j == 1) {          
<a name="l00208"></a>00208                     <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
<a name="l00209"></a>00209                 } <span class="keywordflow">else</span> {
<a name="l00210"></a>00210                     <span class="comment">/* &lt;FIXME&gt; why? &lt;/FIXME&gt; */</span>
<a name="l00211"></a>00211                     pvalue[jselect - 1] = 0.0;
<a name="l00212"></a>00212                 }
<a name="l00213"></a>00213             } <span class="keywordflow">else</span> {
<a name="l00214"></a>00214                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
<a name="l00215"></a>00215                 <span class="keywordflow">break</span>;
<a name="l00216"></a>00216             }
<a name="l00217"></a>00217         } <span class="keywordflow">else</span> {
<a name="l00218"></a>00218             <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
<a name="l00219"></a>00219             <span class="keywordflow">break</span>;
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 }       
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 
<a name="l00233"></a><a class="code" href="Node_8c.html#a2">00233</a> SEXP <a class="code" href="Node_8c.html#a2">R_Node</a>(SEXP learnsample, SEXP weights, SEXP fitmem, SEXP controls) {
<a name="l00234"></a>00234             
<a name="l00235"></a>00235      SEXP ans;
<a name="l00236"></a>00236      
<a name="l00237"></a>00237      PROTECT(ans = allocVector(VECSXP, <a class="code" href="party_8h.html#a9">NODE_LENGTH</a>));
<a name="l00238"></a>00238      <a class="code" href="S3Classes_8c.html#a0">C_init_node</a>(ans, <a class="code" href="Classes_8c.html#a93">get_nobs</a>(learnsample), <a class="code" href="Classes_8c.html#a94">get_ninputs</a>(learnsample), 
<a name="l00239"></a>00239                  <a class="code" href="Classes_8c.html#a103">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#a99">get_splitctrl</a>(controls)),
<a name="l00240"></a>00240                  <a class="code" href="Utils_8c.html#a19">ncol</a>(GET_SLOT(GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>), 
<a name="l00241"></a>00241                       <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>)));
<a name="l00242"></a>00242 
<a name="l00243"></a>00243      <a class="code" href="Node_8c.html#a1">C_Node</a>(ans, learnsample, weights, fitmem, controls, 0);
<a name="l00244"></a>00244      UNPROTECT(1);
<a name="l00245"></a>00245      <span class="keywordflow">return</span>(ans);
<a name="l00246"></a>00246 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 24 18:26:16 2006 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
