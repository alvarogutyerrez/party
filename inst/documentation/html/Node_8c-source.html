<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: Node.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>Node.c</h1><a href="Node_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
00010 
00011 
<a name="l00022"></a><a class="code" href="Node_8c.html#a0">00022</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a0">C_prediction</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *y, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> q, <span class="keyword">const</span> <span class="keywordtype">double</span> *weights, 
00023                   <span class="keyword">const</span> <span class="keywordtype">double</span> sweights, <span class="keywordtype">double</span> *ans) {
00024 
00025     <span class="keywordtype">int</span> i, j, jn;
00026     
00027     <span class="keywordflow">for</span> (j = 0; j &lt; q; j++) {
00028         ans[j] = 0.0;
00029         jn = j * n;
00030         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) 
00031             ans[j] += weights[i] * y[jn + i];
00032         ans[j] = ans[j] / sweights;
00033     }
00034 }
00035 
00036 
<a name="l00048"></a><a class="code" href="Node_8h.html#a0">00048</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a1">C_Node</a>(SEXP node, SEXP learnsample, SEXP weights, 
00049             SEXP fitmem, SEXP controls, <span class="keywordtype">int</span> TERMINAL) {
00050     
00051     <span class="keywordtype">int</span> nobs, ninputs, jselect, yORDERED, q, j;
00052     <span class="keywordtype">double</span> mincriterion, sweights, *dprediction;
00053     <span class="keywordtype">double</span> *teststat, *pvalue, smax, cutpoint = 0.0, maxstat = 0.0;
00054     <span class="keywordtype">double</span> *standstat, *splitstat;
00055     SEXP responses, inputs, y, x, expcovinf, thisweights, linexpcov;
00056     SEXP varctrl, splitctrl, gtctrl, tgctrl, split, joint;
00057     
00058     nobs = <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample);
00059     ninputs = <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample);
00060     varctrl = <a class="code" href="Classes_8c.html#a94">get_varctrl</a>(controls);
00061     splitctrl = <a class="code" href="Classes_8c.html#a95">get_splitctrl</a>(controls);
00062     gtctrl = <a class="code" href="Classes_8c.html#a96">get_gtctrl</a>(controls);
00063     tgctrl = <a class="code" href="Classes_8c.html#a97">get_tgctrl</a>(controls);
00064     mincriterion = <a class="code" href="Classes_8c.html#a98">get_mincriterion</a>(gtctrl);
00065     responses = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>);
00066     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00067     yORDERED = <a class="code" href="Classes_8c.html#a77">is_ordinal</a>(responses, 1); 
00068     y = <a class="code" href="Classes_8c.html#a73">get_transformation</a>(responses, 1);
00069     q = <a class="code" href="Utils_8c.html#a19">ncol</a>(y);
00070     joint = GET_SLOT(responses, <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>);
00071 
00072     <span class="comment">/* &lt;FIXME&gt; we compute C_GlobalTest even for TERMINAL nodes! &lt;/FIXME&gt; */</span>
00073 
00074     <span class="comment">/* compute the test statistics and the node criteria for each input */</span>        
00075     <a class="code" href="IndependenceTest_8c.html#a4">C_GlobalTest</a>(learnsample, weights, fitmem, varctrl,
00076                  gtctrl, <a class="code" href="Classes_8c.html#a70">get_minsplit</a>(splitctrl), 
00077                  REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node)), REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node)));
00078     
00079     <span class="comment">/* sum of weights: C_GlobalTest did nothing if sweights &lt; mincriterion */</span>
00080     sweights = REAL(GET_SLOT(GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>), 
00081                              <a class="code" href="Classes_8c.html#a5">PL2_sumweightsSym</a>))[0];
00082 
00083     <span class="comment">/* compute the prediction of this node */</span>
00084     dprediction = REAL(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(node));
00085 
00086     <span class="comment">/* &lt;FIXME&gt; feed raw numeric values OR dummy encoded factors as y </span>
00087 <span class="comment">       Problem: what happens for survival times ? */</span>
00088     <a class="code" href="Node_8c.html#a0">C_prediction</a>(REAL(joint), nobs, <a class="code" href="Utils_8c.html#a19">ncol</a>(joint), REAL(weights), 
00089                      sweights, dprediction);
00090     <span class="comment">/* &lt;/FIXME&gt; */</span>
00091 
00092     teststat = REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node));
00093     pvalue = REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node));
00094 
00095     <span class="comment">/* try the two out of ninputs best inputs variables */</span>
00096     <span class="comment">/* &lt;FIXME&gt; be more flexible and add a parameter controlling</span>
00097 <span class="comment">               the number of inputs tried &lt;/FIXME&gt; */</span>
00098     <span class="keywordflow">for</span> (j = 0; j &lt; 2; j++) {
00099 
00100         smax = <a class="code" href="Utils_8c.html#a5">C_max</a>(pvalue, ninputs);
00101         REAL(<a class="code" href="S3Classes_8c.html#a6">S3get_maxcriterion</a>(node))[0] = smax;
00102     
00103         <span class="comment">/* if the global null hypothesis was rejected */</span>
00104         <span class="keywordflow">if</span> (smax &gt; mincriterion &amp;&amp; !TERMINAL) {
00105 
00106             <span class="comment">/* the input variable with largest association to the response */</span>
00107             jselect = <a class="code" href="Utils_8c.html#a20">C_whichmax</a>(pvalue, teststat, ninputs) + 1;
00108 
00109             <span class="comment">/* get the raw numeric values or the codings of a factor */</span>
00110             x = <a class="code" href="Classes_8c.html#a75">get_variable</a>(inputs, jselect);
00111             <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, jselect)) {
00112                 expcovinf = GET_SLOT(<a class="code" href="Classes_8c.html#a84">get_varmemory</a>(fitmem, jselect), 
00113                                     <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
00114                 thisweights = <a class="code" href="Classes_8c.html#a91">get_weights</a>(fitmem, jselect);
00115             } <span class="keywordflow">else</span> {
00116                 expcovinf = GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
00117                thisweights = weights;
00118             }
00119 
00120             <span class="comment">/* &lt;FIXME&gt; handle ordered factors separatly??? &lt;/FIXME&gt; */</span>
00121             <span class="keywordflow">if</span> (!<a class="code" href="Classes_8c.html#a76">is_nominal</a>(inputs, jselect)) {
00122             
00123                 <span class="comment">/* search for a split in a ordered variable x */</span>
00124                 split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00125                 
00126                 <span class="comment">/* check if the n-vector of splitstatistics </span>
00127 <span class="comment">                   should be returned for each primary split */</span>
00128                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a87">get_savesplitstats</a>(tgctrl)) {
00129                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, nobs);
00130                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
00131                 } <span class="keywordflow">else</span> {
00132                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, 0);
00133                     splitstat = REAL(<a class="code" href="Classes_8c.html#a88">get_splitstatistics</a>(fitmem));
00134                 }
00135 
00136                 <a class="code" href="Splits_8c.html#a0">C_split</a>(REAL(x), 1, REAL(y), q, REAL(weights), nobs,
00137                         INTEGER(<a class="code" href="Classes_8c.html#a80">get_ordering</a>(inputs, jselect)), 
00138                         REAL(VECTOR_ELT(GET_SLOT(responses, <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
00139                         yORDERED, splitctrl, 
00140                         GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00141                         expcovinf, REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)), &amp;maxstat,
00142                         splitstat);
00143                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
00144              } <span class="keywordflow">else</span> {
00145            
00146                  <span class="comment">/* search of a set of levels (split) in a numeric variable x */</span>
00147                  split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00148                  
00149                 <span class="comment">/* check if the n-vector of splitstatistics </span>
00150 <span class="comment">                   should be returned for each primary split */</span>
00151                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a87">get_savesplitstats</a>(tgctrl)) {
00152                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
00153                         LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00154                         nobs);
00155                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
00156                 } <span class="keywordflow">else</span> {
00157                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
00158                         LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00159                         0);
00160                     splitstat = REAL(<a class="code" href="Classes_8c.html#a88">get_splitstatistics</a>(fitmem));
00161                 }
00162           
00163                  linexpcov = <a class="code" href="Classes_8c.html#a84">get_varmemory</a>(fitmem, jselect);
00164                  standstat = Calloc(<a class="code" href="Classes_8c.html#a63">get_dimension</a>(linexpcov), <span class="keywordtype">double</span>);
00165                  <a class="code" href="TestStatistic_8c.html#a0">C_standardize</a>(REAL(GET_SLOT(linexpcov, 
00166                                              <a class="code" href="Classes_8c.html#a2">PL2_linearstatisticSym</a>)),
00167                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a0">PL2_expectationSym</a>)),
00168                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a1">PL2_covarianceSym</a>)),
00169                                <a class="code" href="Classes_8c.html#a63">get_dimension</a>(linexpcov), <a class="code" href="Classes_8c.html#a66">get_tol</a>(splitctrl), 
00170                                standstat);
00171  
00172                  <a class="code" href="Splits_8c.html#a2">C_splitcategorical</a>(INTEGER(x), 
00173                                     LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00174                                     REAL(y), q, REAL(weights), 
00175                                     nobs, REAL(VECTOR_ELT(GET_SLOT(responses, 
00176                                                <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
00177                                     yORDERED, standstat, splitctrl, 
00178                                     GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00179                                     expcovinf, &amp;cutpoint, 
00180                                     INTEGER(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)),
00181                                     &amp;maxstat, splitstat);
00182                  Free(standstat);
00183             }
00184             <span class="keywordflow">if</span> (maxstat == 0) {
00185                 warning(<span class="stringliteral">"no admissible split found\n"</span>);
00186             
00187                 <span class="keywordflow">if</span> (j == 1) {          
00188                     <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
00189                 } <span class="keywordflow">else</span> {
00190                     pvalue[jselect - 1] = 0.0;
00191                 }
00192             } <span class="keywordflow">else</span> {
00193                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
00194                 <span class="keywordflow">break</span>;
00195             }
00196         } <span class="keywordflow">else</span> {
00197             <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
00198             <span class="keywordflow">break</span>;
00199         }
00200     }
00201 }       
00202 
00203 
<a name="l00212"></a><a class="code" href="Node_8c.html#a2">00212</a> SEXP <a class="code" href="Node_8c.html#a2">R_Node</a>(SEXP learnsample, SEXP weights, SEXP fitmem, SEXP controls) {
00213             
00214      SEXP ans;
00215      
00216      PROTECT(ans = allocVector(VECSXP, <a class="code" href="party_8h.html#a9">NODE_LENGTH</a>));
00217      <a class="code" href="S3Classes_8c.html#a0">C_init_node</a>(ans, <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample), <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample), 
00218                  <a class="code" href="Classes_8c.html#a99">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#a95">get_splitctrl</a>(controls)),
00219                  <a class="code" href="Utils_8c.html#a19">ncol</a>(GET_SLOT(GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>), 
00220                       <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>)));
00221 
00222      <a class="code" href="Node_8c.html#a1">C_Node</a>(ans, learnsample, weights, fitmem, controls, 0);
00223      UNPROTECT(1);
00224      <span class="keywordflow">return</span>(ans);
00225 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jun 23 14:31:48 2005 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
