<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: Node.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>Node.c</h1><a href="Node_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
00010 
00011 
<a name="l00022"></a><a class="code" href="Node_8c.html#a0">00022</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a0">C_prediction</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *y, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> q, <span class="keyword">const</span> <span class="keywordtype">double</span> *weights, 
00023                   <span class="keyword">const</span> <span class="keywordtype">double</span> sweights, <span class="keywordtype">double</span> *ans) {
00024 
00025     <span class="keywordtype">int</span> i, j, jn;
00026     
00027     <span class="keywordflow">for</span> (j = 0; j &lt; q; j++) {
00028         ans[j] = 0.0;
00029         jn = j * n;
00030         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) 
00031             ans[j] += weights[i] * y[jn + i];
00032         ans[j] = ans[j] / sweights;
00033     }
00034 }
00035 
00036 
<a name="l00048"></a><a class="code" href="Node_8h.html#a0">00048</a> <span class="keywordtype">void</span> <a class="code" href="Node_8c.html#a1">C_Node</a>(SEXP node, SEXP learnsample, SEXP weights, 
00049             SEXP fitmem, SEXP controls, <span class="keywordtype">int</span> TERMINAL) {
00050     
00051     <span class="keywordtype">int</span> nobs, ninputs, jselect, yORDERED, q, j, k, i;
00052     <span class="keywordtype">double</span> mincriterion, sweights, *dprediction;
00053     <span class="keywordtype">double</span> *teststat, *pvalue, smax, cutpoint = 0.0, maxstat = 0.0;
00054     <span class="keywordtype">double</span> *standstat, *splitstat;
00055     SEXP responses, inputs, y, x, expcovinf, thisweights, linexpcov;
00056     SEXP varctrl, splitctrl, gtctrl, tgctrl, split, joint;
00057     <span class="keywordtype">double</span> *dxtransf, *dweights;
00058     <span class="keywordtype">int</span> *itable;
00059     
00060     nobs = <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample);
00061     ninputs = <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample);
00062     varctrl = <a class="code" href="Classes_8c.html#a94">get_varctrl</a>(controls);
00063     splitctrl = <a class="code" href="Classes_8c.html#a95">get_splitctrl</a>(controls);
00064     gtctrl = <a class="code" href="Classes_8c.html#a96">get_gtctrl</a>(controls);
00065     tgctrl = <a class="code" href="Classes_8c.html#a97">get_tgctrl</a>(controls);
00066     mincriterion = <a class="code" href="Classes_8c.html#a98">get_mincriterion</a>(gtctrl);
00067     responses = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>);
00068     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00069     yORDERED = <a class="code" href="Classes_8c.html#a77">is_ordinal</a>(responses, 1); 
00070     y = <a class="code" href="Classes_8c.html#a73">get_transformation</a>(responses, 1);
00071     q = <a class="code" href="Utils_8c.html#a19">ncol</a>(y);
00072     joint = GET_SLOT(responses, <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>);
00073 
00074     <span class="comment">/* &lt;FIXME&gt; we compute C_GlobalTest even for TERMINAL nodes! &lt;/FIXME&gt; */</span>
00075 
00076     <span class="comment">/* compute the test statistics and the node criteria for each input */</span>        
00077     <a class="code" href="IndependenceTest_8c.html#a4">C_GlobalTest</a>(learnsample, weights, fitmem, varctrl,
00078                  gtctrl, <a class="code" href="Classes_8c.html#a70">get_minsplit</a>(splitctrl), 
00079                  REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node)), REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node)));
00080     
00081     <span class="comment">/* sum of weights: C_GlobalTest did nothing if sweights &lt; mincriterion */</span>
00082     sweights = REAL(GET_SLOT(GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>), 
00083                              <a class="code" href="Classes_8c.html#a5">PL2_sumweightsSym</a>))[0];
00084 
00085     <span class="comment">/* compute the prediction of this node */</span>
00086     dprediction = REAL(<a class="code" href="S3Classes_8c.html#a11">S3get_prediction</a>(node));
00087 
00088     <span class="comment">/* &lt;FIXME&gt; feed raw numeric values OR dummy encoded factors as y </span>
00089 <span class="comment">       Problem: what happens for survival times ? */</span>
00090     <a class="code" href="Node_8c.html#a0">C_prediction</a>(REAL(joint), nobs, <a class="code" href="Utils_8c.html#a19">ncol</a>(joint), REAL(weights), 
00091                      sweights, dprediction);
00092     <span class="comment">/* &lt;/FIXME&gt; */</span>
00093 
00094     teststat = REAL(<a class="code" href="S3Classes_8c.html#a4">S3get_teststat</a>(node));
00095     pvalue = REAL(<a class="code" href="S3Classes_8c.html#a5">S3get_criterion</a>(node));
00096 
00097     <span class="comment">/* try the two out of ninputs best inputs variables */</span>
00098     <span class="comment">/* &lt;FIXME&gt; be more flexible and add a parameter controlling</span>
00099 <span class="comment">               the number of inputs tried &lt;/FIXME&gt; */</span>
00100     <span class="keywordflow">for</span> (j = 0; j &lt; 2; j++) {
00101 
00102         smax = <a class="code" href="Utils_8c.html#a5">C_max</a>(pvalue, ninputs);
00103         REAL(<a class="code" href="S3Classes_8c.html#a6">S3get_maxcriterion</a>(node))[0] = smax;
00104     
00105         <span class="comment">/* if the global null hypothesis was rejected */</span>
00106         <span class="keywordflow">if</span> (smax &gt; mincriterion &amp;&amp; !TERMINAL) {
00107 
00108             <span class="comment">/* the input variable with largest association to the response */</span>
00109             jselect = <a class="code" href="Utils_8c.html#a20">C_whichmax</a>(pvalue, teststat, ninputs) + 1;
00110 
00111             <span class="comment">/* get the raw numeric values or the codings of a factor */</span>
00112             x = <a class="code" href="Classes_8c.html#a75">get_variable</a>(inputs, jselect);
00113             <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, jselect)) {
00114                 expcovinf = GET_SLOT(<a class="code" href="Classes_8c.html#a84">get_varmemory</a>(fitmem, jselect), 
00115                                     <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
00116                 thisweights = <a class="code" href="Classes_8c.html#a91">get_weights</a>(fitmem, jselect);
00117             } <span class="keywordflow">else</span> {
00118                 expcovinf = GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a3">PL2_expcovinfSym</a>);
00119                 thisweights = weights;
00120             }
00121 
00122             <span class="comment">/* &lt;FIXME&gt; handle ordered factors separatly??? &lt;/FIXME&gt; */</span>
00123             <span class="keywordflow">if</span> (!<a class="code" href="Classes_8c.html#a76">is_nominal</a>(inputs, jselect)) {
00124             
00125                 <span class="comment">/* search for a split in a ordered variable x */</span>
00126                 split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00127                 
00128                 <span class="comment">/* check if the n-vector of splitstatistics </span>
00129 <span class="comment">                   should be returned for each primary split */</span>
00130                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a87">get_savesplitstats</a>(tgctrl)) {
00131                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, nobs);
00132                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
00133                 } <span class="keywordflow">else</span> {
00134                     <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, 0);
00135                     splitstat = REAL(<a class="code" href="Classes_8c.html#a88">get_splitstatistics</a>(fitmem));
00136                 }
00137 
00138                 <a class="code" href="Splits_8c.html#a0">C_split</a>(REAL(x), 1, REAL(y), q, REAL(weights), nobs,
00139                         INTEGER(<a class="code" href="Classes_8c.html#a80">get_ordering</a>(inputs, jselect)), 
00140                         REAL(VECTOR_ELT(GET_SLOT(responses, <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
00141                         yORDERED, splitctrl, 
00142                         GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00143                         expcovinf, REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)), &amp;maxstat,
00144                         splitstat);
00145                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
00146              } <span class="keywordflow">else</span> {
00147            
00148                  <span class="comment">/* search of a set of levels (split) in a numeric variable x */</span>
00149                  split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00150                  
00151                 <span class="comment">/* check if the n-vector of splitstatistics </span>
00152 <span class="comment">                   should be returned for each primary split */</span>
00153                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a87">get_savesplitstats</a>(tgctrl)) {
00154                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
00155                         LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00156                         nobs);
00157                     splitstat = REAL(<a class="code" href="S3Classes_8c.html#a24">S3get_splitstatistics</a>(split));
00158                 } <span class="keywordflow">else</span> {
00159                     <a class="code" href="S3Classes_8c.html#a15">C_init_nominalsplit</a>(split, 
00160                         LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00161                         0);
00162                     splitstat = REAL(<a class="code" href="Classes_8c.html#a88">get_splitstatistics</a>(fitmem));
00163                 }
00164           
00165                  linexpcov = <a class="code" href="Classes_8c.html#a84">get_varmemory</a>(fitmem, jselect);
00166                  standstat = Calloc(<a class="code" href="Classes_8c.html#a63">get_dimension</a>(linexpcov), <span class="keywordtype">double</span>);
00167                  <a class="code" href="TestStatistic_8c.html#a0">C_standardize</a>(REAL(GET_SLOT(linexpcov, 
00168                                              <a class="code" href="Classes_8c.html#a2">PL2_linearstatisticSym</a>)),
00169                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a0">PL2_expectationSym</a>)),
00170                                REAL(GET_SLOT(linexpcov, <a class="code" href="Classes_8c.html#a1">PL2_covarianceSym</a>)),
00171                                <a class="code" href="Classes_8c.html#a63">get_dimension</a>(linexpcov), <a class="code" href="Classes_8c.html#a66">get_tol</a>(splitctrl), 
00172                                standstat);
00173  
00174                  <a class="code" href="Splits_8c.html#a2">C_splitcategorical</a>(INTEGER(x), 
00175                                     LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)), 
00176                                     REAL(y), q, REAL(weights), 
00177                                     nobs, REAL(VECTOR_ELT(GET_SLOT(responses, 
00178                                                <a class="code" href="Classes_8c.html#a34">PL2_scoresSym</a>), 0)),
00179                                     yORDERED, standstat, splitctrl, 
00180                                     GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00181                                     expcovinf, &amp;cutpoint, 
00182                                     INTEGER(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split)),
00183                                     &amp;maxstat, splitstat);
00184 
00185                  <span class="comment">/* compute which levels of a factor are available in this node </span>
00186 <span class="comment">                    (for printing) later on. A real `table' for this node would</span>
00187 <span class="comment">                    induce too much overhead here. Maybe later. */</span>
00188                     
00189                  itable = INTEGER(<a class="code" href="S3Classes_8c.html#a25">S3get_table</a>(split));
00190                  dxtransf = REAL(<a class="code" href="Classes_8c.html#a73">get_transformation</a>(inputs, jselect));
00191                  dweights = REAL(thisweights);
00192                  <span class="keywordflow">for</span> (k = 0; k &lt; LENGTH(<a class="code" href="Classes_8c.html#a81">get_levels</a>(inputs, jselect)); k++) {
00193                      itable[k] = 0;
00194                      <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00195                          <span class="keywordflow">if</span> (dxtransf[k * nobs + i] * dweights[i] &gt; 0) {
00196                              itable[k] = 1;
00197                              <span class="keywordflow">continue</span>;
00198                          }
00199                      }
00200                  }
00201 
00202                  Free(standstat);
00203             }
00204             <span class="keywordflow">if</span> (maxstat == 0) {
00205                 warning(<span class="stringliteral">"no admissible split found\n"</span>);
00206             
00207                 <span class="keywordflow">if</span> (j == 1) {          
00208                     <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
00209                 } <span class="keywordflow">else</span> {
00210                     <span class="comment">/* &lt;FIXME&gt; why? &lt;/FIXME&gt; */</span>
00211                     pvalue[jselect - 1] = 0.0;
00212                 }
00213             } <span class="keywordflow">else</span> {
00214                 <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, jselect);
00215                 <span class="keywordflow">break</span>;
00216             }
00217         } <span class="keywordflow">else</span> {
00218             <a class="code" href="S3Classes_8c.html#a7">S3set_nodeterminal</a>(node);
00219             <span class="keywordflow">break</span>;
00220         }
00221     }
00222 }       
00223 
00224 
<a name="l00233"></a><a class="code" href="Node_8c.html#a2">00233</a> SEXP <a class="code" href="Node_8c.html#a2">R_Node</a>(SEXP learnsample, SEXP weights, SEXP fitmem, SEXP controls) {
00234             
00235      SEXP ans;
00236      
00237      PROTECT(ans = allocVector(VECSXP, <a class="code" href="party_8h.html#a9">NODE_LENGTH</a>));
00238      <a class="code" href="S3Classes_8c.html#a0">C_init_node</a>(ans, <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample), <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample), 
00239                  <a class="code" href="Classes_8c.html#a99">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#a95">get_splitctrl</a>(controls)),
00240                  <a class="code" href="Utils_8c.html#a19">ncol</a>(GET_SLOT(GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a47">PL2_responsesSym</a>), 
00241                       <a class="code" href="Classes_8c.html#a37">PL2_jointtransfSym</a>)));
00242 
00243      <a class="code" href="Node_8c.html#a1">C_Node</a>(ans, learnsample, weights, fitmem, controls, 0);
00244      UNPROTECT(1);
00245      <span class="keywordflow">return</span>(ans);
00246 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jan 18 11:23:28 2006 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
