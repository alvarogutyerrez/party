<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>party: RandomForest.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_6c30642956b040afcd6ed9c9ec492c91.html">src</a>
  </div>
</div>
<div class="contents">
<h1>RandomForest.c</h1><a href="RandomForest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="party_8h.html">party.h</a>&quot;</span>
<a name="l00010"></a>00010 
<a name="l00022"></a><a class="code" href="RandomForest_8c.html#a4f54420cb561055a4e545f7e1359fb87">00022</a> SEXP <a class="code" href="RandomForest_8c.html#a4f54420cb561055a4e545f7e1359fb87">R_Ensemble</a>(SEXP learnsample, SEXP weights, SEXP bwhere, SEXP bweights, 
<a name="l00023"></a>00023                 SEXP fitmem, SEXP controls) {
<a name="l00024"></a>00024             
<a name="l00025"></a>00025      SEXP nweights, tree, where, ans, bw;
<a name="l00026"></a>00026      <span class="keywordtype">double</span> *dnweights, *dweights, sw = 0.0, *prob, tmp;
<a name="l00027"></a>00027      <span class="keywordtype">int</span> nobs, i, b, B , nodenum = 1, *iweights, *iweightstmp, 
<a name="l00028"></a>00028          *iwhere, replace, fraction, wgrzero = 0, realweights = 0;
<a name="l00029"></a>00029      <span class="keywordtype">int</span> j, k, l;
<a name="l00030"></a>00030      
<a name="l00031"></a>00031      B = <a class="code" href="Classes_8c.html#a899349b79a444c39ff23856bd802e096">get_ntree</a>(controls);
<a name="l00032"></a>00032      nobs = <a class="code" href="Classes_8c.html#a45df17685bc6c95d03fb65b6f6214de0">get_nobs</a>(learnsample);
<a name="l00033"></a>00033      
<a name="l00034"></a>00034      PROTECT(ans = allocVector(VECSXP, B));
<a name="l00035"></a>00035 
<a name="l00036"></a>00036      iweights = Calloc(nobs, <span class="keywordtype">int</span>);
<a name="l00037"></a>00037      iweightstmp = Calloc(nobs, <span class="keywordtype">int</span>);
<a name="l00038"></a>00038      prob = Calloc(nobs, <span class="keywordtype">double</span>);
<a name="l00039"></a>00039      dweights = REAL(weights);
<a name="l00040"></a>00040 
<a name="l00041"></a>00041      <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
<a name="l00042"></a>00042          <span class="comment">/* sum of weights */</span>
<a name="l00043"></a>00043          sw += dweights[i];
<a name="l00044"></a>00044          <span class="comment">/* number of weights &gt; 0 */</span>
<a name="l00045"></a>00045          <span class="keywordflow">if</span> (dweights[i] &gt; 0) wgrzero++;
<a name="l00046"></a>00046          <span class="comment">/* case weights or real weights? */</span>
<a name="l00047"></a>00047          <span class="keywordflow">if</span> (dweights[i] - ftrunc(dweights[i]) &gt; 0) 
<a name="l00048"></a>00048              realweights = 1;
<a name="l00049"></a>00049      }
<a name="l00050"></a>00050      <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++)
<a name="l00051"></a>00051          prob[i] = dweights[i]/sw;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053      replace = <a class="code" href="Classes_8c.html#a2c31f2150a75ae67496074deeaea1f96">get_replace</a>(controls);
<a name="l00054"></a>00054      <span class="comment">/* fraction of number of obs with weight &gt; 0 */</span>
<a name="l00055"></a>00055      <span class="keywordflow">if</span> (realweights) {
<a name="l00056"></a>00056          <span class="comment">/* fraction of number of obs with weight &gt; 0 for real weights*/</span>
<a name="l00057"></a>00057          tmp = (<a class="code" href="Classes_8c.html#a3367507eb875c7601cdb9d77f15b5871">get_fraction</a>(controls) * wgrzero);
<a name="l00058"></a>00058      } <span class="keywordflow">else</span> {
<a name="l00059"></a>00059          <span class="comment">/* fraction of sum of weights for case weights */</span>
<a name="l00060"></a>00060          tmp = (<a class="code" href="Classes_8c.html#a3367507eb875c7601cdb9d77f15b5871">get_fraction</a>(controls) * sw);
<a name="l00061"></a>00061      }
<a name="l00062"></a>00062      fraction = (int) ftrunc(tmp);
<a name="l00063"></a>00063      <span class="keywordflow">if</span> (ftrunc(tmp) &lt; tmp) fraction++;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065      <span class="keywordflow">if</span> (!replace) {
<a name="l00066"></a>00066          <span class="keywordflow">if</span> (fraction &lt; 10)
<a name="l00067"></a>00067              error(<span class="stringliteral">&quot;fraction of %f is too small&quot;</span>, fraction);
<a name="l00068"></a>00068      }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070      <span class="comment">/* &lt;FIXME&gt; can we call those guys ONCE? what about the deeper</span>
<a name="l00071"></a>00071 <span class="comment">         calls??? &lt;/FIXME&gt; */</span>
<a name="l00072"></a>00072      GetRNGstate();
<a name="l00073"></a>00073   
<a name="l00074"></a>00074      <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a1dce954023466029dc9218354d57821e">get_trace</a>(controls))
<a name="l00075"></a>00075          Rprintf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00076"></a>00076      <span class="keywordflow">for</span> (b  = 0; b &lt; B; b++) {
<a name="l00077"></a>00077          SET_VECTOR_ELT(ans, b, tree = allocVector(VECSXP, <a class="code" href="party_8h.html#a2594b3a85c654c34048133cb81ad0fab">NODE_LENGTH</a> + 1));
<a name="l00078"></a>00078          SET_VECTOR_ELT(bwhere, b, where = allocVector(INTSXP, nobs));
<a name="l00079"></a>00079          SET_VECTOR_ELT(bweights, b, bw = allocVector(REALSXP, nobs));
<a name="l00080"></a>00080          
<a name="l00081"></a>00081          iwhere = INTEGER(where);
<a name="l00082"></a>00082          <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) iwhere[i] = 0;
<a name="l00083"></a>00083      
<a name="l00084"></a>00084          <a class="code" href="S3Classes_8c.html#af837f0cf74c62c53c74138c4dbb9acc0">C_init_node</a>(tree, nobs, <a class="code" href="Classes_8c.html#a9117d8f57ea1378c725c7299d6cc2923">get_ninputs</a>(learnsample), 
<a name="l00085"></a>00085                      <a class="code" href="Classes_8c.html#ab89e4da7a60580c3adbe7c4f4935581c">get_maxsurrogate</a>(<a class="code" href="Classes_8c.html#ad914bd038dca4d2a1b9847f46bdb78f9">get_splitctrl</a>(controls)),
<a name="l00086"></a>00086                      <a class="code" href="Utils_8c.html#af1f46cc3e98630497a1ccb21d943fe65">ncol</a>(<a class="code" href="Classes_8c.html#ab86d70ff194260cc9bd391d3ff55b157">get_predict_trafo</a>(GET_SLOT(learnsample, 
<a name="l00087"></a>00087                                                    <a class="code" href="Classes_8c.html#a9ad5f5cd65458d95a8ffae2d450ec850">PL2_responsesSym</a>))));
<a name="l00088"></a>00088 
<a name="l00089"></a>00089          <span class="comment">/* generate altered weights for perturbation */</span>
<a name="l00090"></a>00090          <span class="keywordflow">if</span> (replace) {
<a name="l00091"></a>00091              <span class="comment">/* weights for a bootstrap sample */</span>
<a name="l00092"></a>00092              rmultinom((<span class="keywordtype">int</span>) sw, prob, nobs, iweights);
<a name="l00093"></a>00093          } <span class="keywordflow">else</span> {
<a name="l00094"></a>00094              <span class="comment">/* weights for sample splitting */</span>
<a name="l00095"></a>00095              <a class="code" href="Utils_8c.html#a88c1a807c7856d57d07d10027d588602">C_SampleSplitting</a>(nobs, prob, iweights, fraction);
<a name="l00096"></a>00096          }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098          nweights = <a class="code" href="S3Classes_8c.html#ac3785782483b5bf4afe9d606e280f3ca">S3get_nodeweights</a>(tree);
<a name="l00099"></a>00099          dnweights = REAL(nweights);
<a name="l00100"></a>00100          <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
<a name="l00101"></a>00101              REAL(bw)[i] = (double) iweights[i];
<a name="l00102"></a>00102              dnweights[i] = REAL(bw)[i];
<a name="l00103"></a>00103          }
<a name="l00104"></a>00104      
<a name="l00105"></a>00105          <a class="code" href="TreeGrow_8c.html#a67d352c38f59d30c7b9954bf5d3a57ad">C_TreeGrow</a>(tree, learnsample, fitmem, controls, iwhere, &amp;nodenum, 1);
<a name="l00106"></a>00106          nodenum = 1;
<a name="l00107"></a>00107          <a class="code" href="Utils_8c.html#a98f2de1eb2ad7315b48e7e2d9e7a829c">C_remove_weights</a>(tree, 0);
<a name="l00108"></a>00108          
<a name="l00109"></a>00109          <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a1dce954023466029dc9218354d57821e">get_trace</a>(controls)) {
<a name="l00110"></a>00110              <span class="comment">/* progress bar; inspired by </span>
<a name="l00111"></a>00111 <span class="comment">             http://avinashjoshi.co.in/2009/10/13/creating-a-progress-bar-in-c/ */</span>
<a name="l00112"></a>00112              Rprintf(<span class="stringliteral">&quot;[&quot;</span>);
<a name="l00113"></a>00113              <span class="comment">/* Print the = until the current percentage */</span>
<a name="l00114"></a>00114              l = (int) ceil( ((<span class="keywordtype">double</span>) b * 50.0) / B);
<a name="l00115"></a>00115              <span class="keywordflow">for</span> (j = 0; j &lt; l; j++)
<a name="l00116"></a>00116                  Rprintf(<span class="stringliteral">&quot;=&quot;</span>);
<a name="l00117"></a>00117              Rprintf(<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l00118"></a>00118              <span class="keywordflow">for</span> (k = j; k &lt; 50; k++)
<a name="l00119"></a>00119                  Rprintf(<span class="stringliteral">&quot; &quot;</span>);
<a name="l00120"></a>00120              Rprintf(<span class="stringliteral">&quot;]&quot;</span>);
<a name="l00121"></a>00121              <span class="comment">/* % completed */</span>
<a name="l00122"></a>00122                  Rprintf(<span class="stringliteral">&quot; %3d%% completed&quot;</span>, j * 2);
<a name="l00123"></a>00123              <span class="comment">/* To delete the previous line */</span>
<a name="l00124"></a>00124              Rprintf(<span class="stringliteral">&quot;\r&quot;</span>);
<a name="l00125"></a>00125              <span class="comment">/* Flush all char in buffer */</span>
<a name="l00126"></a>00126              fflush(stdout);
<a name="l00127"></a>00127          }
<a name="l00128"></a>00128      }
<a name="l00129"></a>00129      <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a1dce954023466029dc9218354d57821e">get_trace</a>(controls))
<a name="l00130"></a>00130          Rprintf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132      PutRNGstate();
<a name="l00133"></a>00133 
<a name="l00134"></a>00134      Free(prob); Free(iweights); Free(iweightstmp);
<a name="l00135"></a>00135      UNPROTECT(1);
<a name="l00136"></a>00136      <span class="keywordflow">return</span>(ans);
<a name="l00137"></a>00137 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue Jul 6 16:21:02 2010 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
