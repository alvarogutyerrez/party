<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>party: SurrogateSplits.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>SurrogateSplits.c</h1><a href="SurrogateSplits_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00009 <span class="preprocessor">#include "<a class="code" href="party_8h.html">party.h</a>"</span>
00010 
<a name="l00021"></a><a class="code" href="SurrogateSplits_8h.html#a0">00021</a> <span class="keywordtype">void</span> <a class="code" href="SurrogateSplits_8c.html#a0">C_surrogates</a>(SEXP node, SEXP learnsample, SEXP weights, SEXP controls, 
00022                   SEXP fitmem) {
00023 
00024     SEXP x, y, expcovinf; 
00025     SEXP splitctrl, inputs; 
00026     SEXP split, thiswhichNA;
00027     <span class="keywordtype">int</span> nobs, ninputs, i, j, k, jselect, maxsurr, *order;
00028     <span class="keywordtype">double</span> ms, cp, *thisweights, *cutpoint, *maxstat, 
00029            *splitstat, *dweights, *tweights, *dx, *dy;
00030     <span class="keywordtype">double</span> cut, *twotab;
00031     
00032     nobs = <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample);
00033     ninputs = <a class="code" href="Classes_8c.html#a90">get_ninputs</a>(learnsample);
00034     splitctrl = <a class="code" href="Classes_8c.html#a95">get_splitctrl</a>(controls);
00035     maxsurr = <a class="code" href="Classes_8c.html#a99">get_maxsurrogate</a>(splitctrl);
00036 
00037     <span class="keywordflow">if</span> (maxsurr != LENGTH(<a class="code" href="S3Classes_8c.html#a10">S3get_surrogatesplits</a>(node)))
00038         error(<span class="stringliteral">"nodes does not have %s surrogate splits"</span>, maxsurr);
00039 
00040     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00041     jselect = <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(<a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node));
00042     y = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(VECTOR_ELT(node, 7));
00043 
00044     tweights = Calloc(nobs, <span class="keywordtype">double</span>);
00045     dweights = REAL(weights);
00046     <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) tweights[i] = dweights[i];
00047     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, jselect)) {
00048         thiswhichNA = <a class="code" href="Classes_8c.html#a83">get_missings</a>(inputs, jselect);
00049         <span class="keywordflow">for</span> (k = 0; k &lt; LENGTH(thiswhichNA); k++)
00050             tweights[INTEGER(thiswhichNA)[k] - 1] = 0.0;
00051     }
00052 
00053     expcovinf = GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a4">PL2_expcovinfssSym</a>);
00054     <a class="code" href="LinearStatistic_8c.html#a2">C_ExpectCovarInfluence</a>(REAL(y), 1, REAL(weights), nobs, expcovinf);
00055     
00056     splitstat = REAL(<a class="code" href="Classes_8c.html#a88">get_splitstatistics</a>(fitmem));
00057     <span class="comment">/* &lt;FIXME&gt; extend `TreeFitMemory' to those as well ... */</span>
00058     maxstat = Calloc(ninputs, <span class="keywordtype">double</span>);
00059     cutpoint = Calloc(ninputs, <span class="keywordtype">double</span>);
00060     order = Calloc(ninputs, <span class="keywordtype">int</span>);
00061     <span class="comment">/* &lt;FIXME&gt; */</span>
00062     
00063     <span class="comment">/* this is essentially an exhaustive search */</span>
00064     <span class="comment">/* &lt;FIXME&gt;: we don't want to do this for random forest like trees </span>
00065 <span class="comment">       &lt;/FIXME&gt;</span>
00066 <span class="comment">     */</span>
00067     <span class="keywordflow">for</span> (j = 0; j &lt; ninputs; j++) {
00068     
00069          order[j] = j + 1;
00070          maxstat[j] = 0.0;
00071          cutpoint[j] = 0.0;
00072 
00073          <span class="comment">/* ordered input variables only (for the moment) */</span>
00074          <span class="keywordflow">if</span> ((j + 1) == jselect || <a class="code" href="Classes_8c.html#a76">is_nominal</a>(inputs, j + 1))
00075              <span class="keywordflow">continue</span>;
00076 
00077          x = <a class="code" href="Classes_8c.html#a75">get_variable</a>(inputs, j + 1);
00078 
00079          <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, j + 1)) {
00080 
00081              thisweights = REAL(<a class="code" href="Classes_8c.html#a91">get_weights</a>(fitmem, j + 1));
00082              <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) thisweights[i] = tweights[i];
00083              thiswhichNA = <a class="code" href="Classes_8c.html#a83">get_missings</a>(inputs, j + 1);
00084              <span class="keywordflow">for</span> (k = 0; k &lt; LENGTH(thiswhichNA); k++)
00085                  thisweights[INTEGER(thiswhichNA)[k] - 1] = 0.0;
00086                  
00087              <a class="code" href="LinearStatistic_8c.html#a2">C_ExpectCovarInfluence</a>(REAL(y), 1, thisweights, nobs, expcovinf);
00088              
00089              <a class="code" href="Splits_8c.html#a0">C_split</a>(REAL(x), 1, REAL(y), 1, thisweights, nobs,
00090                      INTEGER(<a class="code" href="Classes_8c.html#a80">get_ordering</a>(inputs, j + 1)), 0, 0, splitctrl,
00091                      GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00092                      expcovinf, &amp;cp, &amp;ms, splitstat);
00093          } <span class="keywordflow">else</span> {
00094          
00095              <a class="code" href="Splits_8c.html#a0">C_split</a>(REAL(x), 1, REAL(y), 1, tweights, nobs,
00096              INTEGER(<a class="code" href="Classes_8c.html#a80">get_ordering</a>(inputs, j + 1)), 0, 0, splitctrl,
00097              GET_SLOT(fitmem, <a class="code" href="Classes_8c.html#a40">PL2_linexpcov2sampleSym</a>),
00098              expcovinf, &amp;cp, &amp;ms, splitstat);
00099          }
00100 
00101          maxstat[j] = -ms;
00102          cutpoint[j] = cp;
00103     }
00104 
00105     <span class="comment">/* order with respect to maximal statistic */</span>
00106     rsort_with_index(maxstat, order, ninputs);
00107     
00108     twotab = Calloc(4, <span class="keywordtype">double</span>);
00109     
00110     <span class="comment">/* the best `maxsurr' ones are implemented */</span>
00111     <span class="keywordflow">for</span> (j = 0; j &lt; maxsurr; j++) {
00112 
00113         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) twotab[i] = 0.0;
00114         cut = cutpoint[order[j] - 1];
00115         SET_VECTOR_ELT(<a class="code" href="S3Classes_8c.html#a10">S3get_surrogatesplits</a>(node), j, 
00116                        split = allocVector(VECSXP, <a class="code" href="party_8h.html#a20">SPLIT_LENGTH</a>));
00117         <a class="code" href="S3Classes_8c.html#a14">C_init_orderedsplit</a>(split, 0);
00118         <a class="code" href="S3Classes_8c.html#a16">S3set_variableID</a>(split, order[j]);
00119         REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split))[0] = cut;
00120         dx = REAL(<a class="code" href="Classes_8c.html#a75">get_variable</a>(inputs, order[j]));
00121         dy = REAL(y);
00122 
00123         <span class="comment">/* OK, this is a dirty hack: determine if the split </span>
00124 <span class="comment">           goes left or right by the Pearson residual of a 2x2 table.</span>
00125 <span class="comment">           I don't want to use the big caliber here </span>
00126 <span class="comment">        */</span>
00127         <span class="keywordflow">for</span> (i = 0; i &lt; nobs; i++) {
00128             twotab[0] += ((dy[i] == 1) &amp;&amp; (dx[i] &lt;= cut)) * tweights[i];
00129             twotab[1] += (dy[i] == 1) * tweights[i];
00130             twotab[2] += (dx[i] &lt;= cut) * tweights[i];
00131             twotab[3] += tweights[i];
00132         }
00133         <a class="code" href="S3Classes_8c.html#a22">S3set_toleft</a>(split, (<span class="keywordtype">int</span>) (twotab[0] - twotab[1] * twotab[2] / 
00134                      twotab[3]) &gt; 0);
00135     }
00136     
00137     Free(maxstat);
00138     Free(cutpoint);
00139     Free(order);
00140     Free(tweights);
00141     Free(twotab);
00142 }
00143 
<a name="l00154"></a><a class="code" href="SurrogateSplits_8c.html#a1">00154</a> SEXP <a class="code" href="SurrogateSplits_8c.html#a1">R_surrogates</a>(SEXP node, SEXP learnsample, SEXP weights, SEXP controls, 
00155                   SEXP fitmem) {
00156 
00157     <a class="code" href="SurrogateSplits_8c.html#a0">C_surrogates</a>(node, learnsample, weights, controls, fitmem);
00158     <span class="keywordflow">return</span>(<a class="code" href="S3Classes_8c.html#a10">S3get_surrogatesplits</a>(node));
00159     
00160 }
00161 
<a name="l00169"></a><a class="code" href="SurrogateSplits_8h.html#a1">00169</a> <span class="keywordtype">void</span> <a class="code" href="SurrogateSplits_8c.html#a2">C_splitsurrogate</a>(SEXP node, SEXP learnsample) {
00170 
00171     SEXP weights, split, surrsplit;
00172     SEXP inputs, whichNA;
00173     <span class="keywordtype">double</span> cutpoint, *dx, *dweights, *leftweights, *rightweights;
00174     <span class="keywordtype">int</span> *iwhichNA, k;
00175     <span class="keywordtype">int</span> nobs, i, nna, ns;
00176                     
00177     weights = <a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(node);
00178     dweights = REAL(weights);
00179     inputs = GET_SLOT(learnsample, <a class="code" href="Classes_8c.html#a48">PL2_inputsSym</a>);
00180     nobs = <a class="code" href="Classes_8c.html#a89">get_nobs</a>(learnsample);
00181             
00182     leftweights = REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="S3Classes_8c.html#a12">S3get_leftnode</a>(node)));
00183     rightweights = REAL(<a class="code" href="S3Classes_8c.html#a3">S3get_nodeweights</a>(<a class="code" href="S3Classes_8c.html#a13">S3get_rightnode</a>(node)));
00184     surrsplit = <a class="code" href="S3Classes_8c.html#a10">S3get_surrogatesplits</a>(node);
00185 
00186     <span class="comment">/* if the primary split has any missings */</span>
00187     split = <a class="code" href="S3Classes_8c.html#a9">S3get_primarysplit</a>(node);
00188     <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split))) {
00189 
00190         <span class="comment">/* where are the missings? */</span>
00191         whichNA = <a class="code" href="Classes_8c.html#a83">get_missings</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split));
00192         iwhichNA = INTEGER(whichNA);
00193         nna = LENGTH(whichNA);
00194 
00195         <span class="comment">/* for all missing values ... */</span>
00196         <span class="keywordflow">for</span> (k = 0; k &lt; nna; k++) {
00197             ns = 0;
00198             i = iwhichNA[k] - 1;
00199             <span class="keywordflow">if</span> (dweights[i] == 0) <span class="keywordflow">continue</span>;
00200             
00201             <span class="comment">/* loop over surrogate splits until an appropriate one is found */</span>
00202             <span class="keywordflow">while</span>(TRUE) {
00203             
00204                 <span class="keywordflow">if</span> (ns &gt;= LENGTH(surrsplit)) <span class="keywordflow">break</span>;
00205             
00206                 split = VECTOR_ELT(surrsplit, ns);
00207                 <span class="keywordflow">if</span> (<a class="code" href="Classes_8c.html#a79">has_missings</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split))) {
00208                     <span class="keywordflow">if</span> (INTEGER(<a class="code" href="Classes_8c.html#a83">get_missings</a>(inputs, 
00209                             <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)))[i]) {
00210                         ns++;
00211                         <span class="keywordflow">continue</span>;
00212                     }
00213                 }
00214 
00215                 cutpoint = REAL(<a class="code" href="S3Classes_8c.html#a23">S3get_splitpoint</a>(split))[0];
00216                 dx = REAL(<a class="code" href="Classes_8c.html#a75">get_variable</a>(inputs, <a class="code" href="S3Classes_8c.html#a17">S3get_variableID</a>(split)));
00217 
00218                 <span class="keywordflow">if</span> (<a class="code" href="S3Classes_8c.html#a21">S3get_toleft</a>(split)) {
00219                     <span class="keywordflow">if</span> (dx[i] &lt;= cutpoint) {
00220                         leftweights[i] = dweights[i];
00221                         rightweights[i] = 0.0;
00222                     } <span class="keywordflow">else</span> {
00223                         rightweights[i] = dweights[i];
00224                         leftweights[i] = 0.0;
00225                     }
00226                 } <span class="keywordflow">else</span> {
00227                     <span class="keywordflow">if</span> (dx[i] &lt;= cutpoint) {
00228                         rightweights[i] = dweights[i];
00229                         leftweights[i] = 0.0;
00230                     } <span class="keywordflow">else</span> {
00231                         leftweights[i] = dweights[i];
00232                         rightweights[i] = 0.0;
00233                     }
00234                 }
00235                 <span class="keywordflow">break</span>;
00236             }
00237         }
00238     }
00239 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jan 18 11:23:28 2006 for party by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
